---
categories:
- computing
date: 2015-08-27T00:00:00Z
tag:
- nimble
url: /2015/08/27/nimble-model-construction/
---



<pre class="r"><code>library(&quot;nimble&quot;)</code></pre>
<pre><code>## 
## Attaching package: &#39;nimble&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     simulate</code></pre>
<pre class="r"><code>library(&quot;lazyeval&quot;)
library(&quot;methods&quot;)</code></pre>
<p>Can we declare the <code>nimbleCode</code> parts in sections? Such as defining the model and priors in separate, reusable code blocks? Here’s a “model” block:</p>
<pre class="r"><code>model &lt;- nimbleCode({
  for (i in 1:N){
    theta[i] ~ dgamma(alpha,beta)
    lambda[i] &lt;- theta[i]*t[i]
    x[i] ~ dpois(lambda[i])
  }
})</code></pre>
<p>We may also wish to define the priors separately, and with specified list of hyperparameters for the priors. Perhaps the need to use <code>quote</code> and to specify each line as a list item, instead of as a block defined with <code>{</code>, is not ideal, but non-standard evaluation is a bit of a wild west still.</p>
<pre class="r"><code>hyperparameters &lt;- list(lambda = 1.0, a = 0.1, b = 1.0)

priors &lt;- nimbleCode({
  alpha ~ dexp(lambda)
  beta ~ dgamma(a,b)
})</code></pre>
<p>Having done so, we can construct a <code>nimbleCode</code> block by passing our chosen hyperparameters to the priors and concatenating the model and priors.</p>
<pre class="r"><code>P &lt;- as.expression(sapply(priors, lazyeval::interp, .values = hyperparameters)[-1])
pumpCode &lt;- c(model, P)</code></pre>
<p>The result appears to work as a functional <code>nimbleCode</code> block; though note the resulting expression is not quite identical to the one we would typically write (e.g. without commas):</p>
<pre class="r"><code>pumpCode</code></pre>
<pre><code>## expression({
##     for (i in 1:N) {
##         theta[i] ~ dgamma(alpha, beta)
##         lambda[i] &lt;- theta[i] * t[i]
##         x[i] ~ dpois(lambda[i])
##     }
## }, alpha ~ dexp(1), beta ~ dgamma(0.1, 1))</code></pre>
<p>Here we just specify the rest of the model:</p>
<pre class="r"><code>pumpConsts &lt;- list(N = 10, 
                   t = c(94.3, 15.7, 62.9, 126, 5.24,
                         31.4, 1.05, 1.05, 2.1, 10.5))
pumpData &lt;- list(x = c(5, 1, 5, 14, 3, 19, 1, 1, 4, 22))
pumpInits &lt;- list(alpha = 1, 
                  beta = 1,
                  theta = rep(0.1, pumpConsts$N))

pump &lt;- nimbleModel(code = pumpCode, 
                    name = &#39;pump&#39;, 
                    constants = pumpConsts,
                    data = pumpData, 
                    inits = pumpInits)</code></pre>
<pre><code>## defining model...</code></pre>
<pre><code>## building model...</code></pre>
<pre><code>## setting data and initial values...</code></pre>
<pre><code>## running calculate on model (any error reports that follow may simply
## reflect missing values in model variables) ...</code></pre>
<pre><code>## </code></pre>
<pre><code>## checking model sizes and dimensions...</code></pre>
<pre><code>## </code></pre>
<pre><code>## model building finished.</code></pre>
<p>and then verify that it runs.</p>
<pre class="r"><code>Cmodel &lt;- compileNimble(pump)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.</code></pre>
<pre><code>## compilation finished.</code></pre>
<pre class="r"><code>mcmcspec &lt;- configureMCMC(pump, print=FALSE)
mcmc &lt;- buildMCMC(mcmcspec)
Cmcmc &lt;- compileNimble(mcmc, project = Cmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.
## compilation finished.</code></pre>
<pre class="r"><code>Cmcmc$run(1000)</code></pre>
<pre><code>## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|</code></pre>
<pre><code>## NULL</code></pre>
<pre class="r"><code>samples &lt;- as.data.frame(as.matrix(Cmcmc$mvSamples))
plot(samples[ , &#39;alpha&#39;], samples[ , &#39;beta&#39;], xlab = expression(alpha), ylab = expression(beta))</code></pre>
<p><img src="/lab-notebook/2015-08-27-nimble-model-construction_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>(The plot shows the same correlation issue that arises without using a block sampler that is illustrated in the manual.)</p>
