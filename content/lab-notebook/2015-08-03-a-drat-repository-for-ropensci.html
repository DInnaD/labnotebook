---
author: Carl Boettiger
date: 2015-08-03T00:00:00Z
title: a drat repository for rOpenSci (draft for ropensci blog)
url: /2015/08/03/a-drat-repository-for-ropensci/
---



<p>We’re happy to announce the launch of a CRAN-style repository for rOpenSci at <a href="http://packages.ropensci.org" class="uri">http://packages.ropensci.org</a></p>
<p>This repository contains the latest nightly builds from the master branch of all rOpenSci packages currently on GitHub. This allows users to install development versions of our software without specialized functions such as <code>install_github()</code>, allows dependencies not hosted on CRAN to still be resolved automatically, and permits the use of <code>update.packages()</code>.</p>
<div id="using-the-repository" class="section level2">
<h2>Using the repository</h2>
<p>To use, simply add <code>packages.ropensci.org</code> to your existing list of R repos, such as:</p>
<pre class="r"><code>options(repos = c(&quot;http://packages.ropensci.org&quot;, getOption(&quot;repos&quot;))</code></pre>
<p>(If you don’t have any default CRAN mirrors selected yet by <code>getOption(&quot;repos&quot;)</code>, you may want to add one now). You can also include this line in specific <code>install.packages()</code> requests:</p>
<pre class="r"><code>install.packages(&quot;taxize&quot;, repos = c(&quot;http://packages.ropensci.org&quot;, &quot;http://cran.rstudio.com&quot;))</code></pre>
</div>
<div id="design" class="section level2">
<h2>Design</h2>
<p>Our goal in creating a CRAN-style package repository (yes, it’s confusing that we use the word “repository” to describe both an individual package source in a GitHub <em>repo</em> as well as a collection of package binaries on a CRAN-like <em>repo</em>… sorry) was to provide users with a way to install the latest development versions of rOpenSci packages that offerred an easier and more seamless alternative to the widely used method of <code>devtools::install_github()</code>. This would be particularly useful for updating all packages at once, or installing development versions that depended on other versions of packages not yet released to CRAN. As an added benefit, we also wanted a system that would allow us to compute anonmyzed download statistics, analogous to what RStudio provides for it’s CRAN mirror. Getting this all to work required the introduction of a few additional technologies.</p>
<div id="drat-and-drat.builder" class="section level3">
<h3><code>drat</code> and <code>drat.builder</code></h3>
<p>While the basic structure of a CRAN-like R repository is simple, used both platforms such as rForge as well as individual developers, kudos really goes to Dirk Eddelbuettel’s <a href="https://github.com/eddelbuettel/drat">drat</a> package for really making this automated, simple, and fun. While <code>drat</code> makes it easy to toss individual packages into a CRAN-like repo (which we often refer to as a <code>drat</code> repo), we needed an easy &amp; automatic way to add a whole list of packages, given their GitHub repos. Rich FitzJohn’s new <a href="https://github.com/richfitz/drat.builder">drat.builder</a> package does precisely this; handling the downloading of packages with some clever record-keeping to avoid building and adding packages which have not changed since the last time the <code>drat</code> repo was built. The sources for building the rOpenSci packages repository can be found in our “drat” GitHub repo: <a href="https://github.com/ropensci/drat" class="uri">https://github.com/ropensci/drat</a></p>
</div>
<div id="dynamic-package-lists-ropkgs" class="section level3">
<h3>Dynamic package lists: <code>ropkgs</code></h3>
<p>With rOpenSci, we wanted to take this one step further. No one wants to have to maintain one more list that must be updated every time a package is successfully on-boarded to the project. Scott Chamberlain’s work with <a href="https://github.com/ropensci/ropkgs">ropkgs</a> provides a convenient way to query the rOpenSci software suite, automatically generating a list of available rOpenSci packages, and filtering them on relevant metadata, such as those that are in good status and installable condition, like so:</p>
<pre class="r"><code>library(&quot;ropkgs&quot;)
out &lt;- ro_pkgs()
good &lt;- out$packages$status == &quot;good&quot;
installable &lt;- out$packages$installable
pkgs &lt;- out$packages$name[installable &amp; good]
</code></pre>
</div>
<div id="the-magic-of-continuous-integration-circleci" class="section level3">
<h3>the magic of continuous integration: CircleCI</h3>
<p>With <code>ropkgs</code>, <code>drat</code> and <code>drat.builder</code>, we now have everything we need to automate the building of the CRAN-like package repository. Now we just need some computing resource that can do the hard work of pulling down all the GitHub packages, building the repository, and securely sending off the binaries somewhere they can be downloaded. Continuous Integration systems turn out to be perfect for this. My favorite CI platform at the moment is <a href="https://circleci.com">CircleCi</a>, for several reasons particularly relevant here:</p>
<ul>
<li>it has a rich API which includes support for <code>POST</code> requests which can trigger a build without making commits to GitHub</li>
<li>it supports custom Docker containers, allowing us to just download a container with most or all the dependencies we need to build packages, etc., without having to wait for them to install manually from source first.</li>
<li>it has a convient web interface for providing secure credentials we’ll need to publish the binary repository to GitHub or Amazon.</li>
</ul>
<p>Circle has other advantages too, like great live help and the ability to ssh into your CI run to troubleshoot when all else fails, but otherwise works like most other CI platforms. More on that another day. You can see the daily builds here: <a href="https://circleci.com/gh/ropensci/drat/tree/gh-pages">CircleCi</a>, which are triggered by a simple <code>POST</code> request running as a cron job. The <a href="https://github.com/ropensci/drat/blob/gh-pages/circle.yml">circle.yml</a> configuration file appears in the project’s drat repo – check out how simple it is!</p>
</div>
<div id="publishing-to-amazon" class="section level3">
<h3>Publishing to Amazon</h3>
<p>The last step would be getting download logs; which is somewhat more complicated than it sounds. <code>drat</code> convienently already handles pushing packages to GitHub’s gh-pages, a free and easy way to provide static hosting. This is free and easy, but isn’t ideal, particularly for large and frequently updated package collections. Also, it is impossible to get download logs from this approach. To avoid these issues, we settled on pushing our package repository to a static site hosted through Amazon’s S3 data storage “buckets.” It’s not free, but for at most a few gigs of space we’ll need it’s still very cost effective. In particular, S3 buckets can generate their own log files, which provides a way to count package downloads.</p>
<p>Secure communication with Amazon S3 system is accomplished using the very nacsent / actively developing <a href="https://github.com/cloudyr/aws.s3">aws.s3</a> R package from the awesome <a href="https://cloudyr.github.io/">cloudyr</a> project.</p>
</div>
<div id="parsing-the-download-logs" class="section level3">
<h3>Parsing the download logs</h3>
<p>Amazon’s S3 logs are rather raw and require some good ol data tidying work to transform them into the conveniently parsed, tidied and IP-address-anonymized format used by RStudio’s download logs. Eventually this too can be accomplished by the CircleCI builds, but at the moment is too computationally intensive for them. A script for this workflow can be found in the project repo, <a href="https://github.com/ropensci/drat/blob/gh-pages/parse_s3_logs.R">parse_s3_logs.R</a>. As the data accumulate we should be able to start publishing the tidy logs.</p>
<p>This project is still in it’s early days, and as ever, we welcome feedback, problems or ideas on the <a href="https://github.com/ropensci/drat/issues">issues tracker</a>.</p>
<p>Now go ahead and install or update some packages from the shiny new <a href="http://packages.ropensci.org" class="uri">http://packages.ropensci.org</a>!</p>
</div>
</div>
