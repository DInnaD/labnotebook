---
categories:
- ecology
date: 2014-12-04T00:00:00Z
tags:
- earlywarning
url: /2014/12/04/lsn-nimble/
---

<p>some sample data</p>
<pre class="r"><code>library(sde)</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: stats4</code></pre>
<pre><code>## Loading required package: fda</code></pre>
<pre><code>## Loading required package: splines</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;fda&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:graphics&#39;:
## 
##     matplot</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre><code>## sde 2.0.15</code></pre>
<pre><code>## Companion package to the book</code></pre>
<pre><code>## &#39;Simulation and Inference for Stochastic Differential Equations With R Examples&#39;</code></pre>
<pre><code>## Iacus, Springer NY, (2008)</code></pre>
<pre><code>## To check the errata corrige of the book, type vignette(&quot;sde.errata&quot;)</code></pre>
<pre class="r"><code>library(nimble)</code></pre>
<pre><code>## 
## Attaching package: &#39;nimble&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:fda&#39;:
## 
##     inprod</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     simulate</code></pre>
<pre class="r"><code>library(methods)
set.seed(123)
d &lt;- expression(0.5 * (10-x))
s &lt;- expression(1) 
data &lt;- as.data.frame(sde.sim(X0=6,drift=d, sigma=s, T=20, N=100))</code></pre>
<pre><code>## sigma.x not provided, attempting symbolic derivation.</code></pre>
<pre class="r"><code>plot(data)</code></pre>
<p><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<div id="lsn-version" class="section level2">
<h2>LSN version</h2>
<p>Test case: Set prior for <code>m</code> <span class="math inline">\(\approx 0\)</span>:</p>
<pre class="r"><code>lsn &lt;- nimbleCode({
   theta ~ dunif(1e-10, 100.0)
   sigma_x ~ dunif(1e-10, 100.0)
   sigma_y ~ dunif(1e-10, 100.0)
       m ~ dunif(-1e2, 1e2)
    x[1] ~ dunif(0, 100)
    y[1] ~ dunif(0, 100) 

  for(i in 1:(N-1)){
    mu_x[i] &lt;- x[i] + y[i] * (theta - x[i]) 
    x[i+1] ~ dnorm(mu_x[i], sd = sigma_x) 
    mu_y[i] &lt;- y[i] + m * t[i]
    y[i+1] ~ dnorm(mu_y[i], sd = sigma_y) 
  }
})</code></pre>
<p>Constants in the model definition are the length of the dataset, <span class="math inline">\(N\)</span> and the time points of the sample. Note we’ve made time explicit, we’ll assume uniform spacing here.</p>
<pre class="r"><code>constants &lt;- list(N = length(data$x), t = 1:length(data$x))</code></pre>
<p>Initial values for the parameters</p>
<pre class="r"><code>inits &lt;- list(theta = 6, m = 0, sigma_x = 1, sigma_y = 1, y = rep(1,constants$N))</code></pre>
<p>and here we go as before:</p>
<pre class="r"><code>Rmodel &lt;- nimbleModel(code = lsn, 
                      constants = constants, 
                      data = data, 
                      inits = inits)</code></pre>
<pre><code>## defining model...</code></pre>
<pre><code>## building model...</code></pre>
<pre><code>## setting data and initial values...</code></pre>
<pre><code>## running calculate on model (any error reports that follow may simply
## reflect missing values in model variables) ...</code></pre>
<pre><code>## </code></pre>
<pre><code>## checking model sizes and dimensions...</code></pre>
<pre><code>## </code></pre>
<pre><code>## model building finished.</code></pre>
<pre class="r"><code>Cmodel &lt;- compileNimble(Rmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.</code></pre>
<pre><code>## compilation finished.</code></pre>
<pre class="r"><code>spec &lt;- configureMCMC(Rmodel, print=TRUE,thin=1e2)
Rmcmc &lt;- buildMCMC(spec)
Cmcmc &lt;- compileNimble(Rmcmc, project = Cmodel)</code></pre>
<pre class="r"><code>Cmcmc$run(1e4)</code></pre>
<pre><code>## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|</code></pre>
<pre><code>## NULL</code></pre>
<p>and examine results</p>
<pre class="r"><code>samples &lt;- as.data.frame(as.matrix(Cmcmc$mvSamples))
dim(samples)</code></pre>
<pre><code>## [1] 100 206</code></pre>
<pre class="r"><code>samples &lt;- samples[,1:4]</code></pre>
<pre class="r"><code>mean(samples$theta)</code></pre>
<pre><code>## [1] 10.11174</code></pre>
<pre class="r"><code>mean(samples$m)</code></pre>
<pre><code>## [1] -1.88765e-05</code></pre>
<pre class="r"><code>mean(samples$sigma_x)</code></pre>
<pre><code>## [1] 0.385018</code></pre>
<pre class="r"><code>plot(samples[ , &#39;m&#39;], type = &#39;l&#39;, xlab = &#39;iteration&#39;, ylab = &#39;m&#39;)
plot(samples[ , &#39;sigma_x&#39;], type = &#39;l&#39;, xlab = &#39;iteration&#39;, ylab = expression(sigma[x]))
plot(samples[ , &#39;sigma_y&#39;], type = &#39;l&#39;, xlab = &#39;iteration&#39;, ylab = expression(sigma[y]))
plot(samples[ , &#39;theta&#39;], type = &#39;l&#39;, xlab = &#39;iteration&#39;, ylab = expression(theta))</code></pre>
<p><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-10-1.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-10-2.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-10-3.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-10-4.png" width="672" /></p>
<pre class="r"><code>hist(samples[, &#39;m&#39;], xlab = &#39;m&#39;)
hist(samples[, &#39;sigma_x&#39;], xlab = expression(sigma[x]))
hist(samples[, &#39;sigma_y&#39;], xlab = expression(sigma[y]))
hist(samples[, &#39;theta&#39;], xlab = expression(theta))</code></pre>
<p><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-11-1.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-11-2.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-11-3.png" width="672" /><img src="/lab-notebook/2014-12-04-lsn-nimble_files/figure-html/unnamed-chunk-11-4.png" width="672" /></p>
</div>
