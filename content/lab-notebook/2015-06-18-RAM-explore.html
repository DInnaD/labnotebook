---
categories:
- ecology
date: 2015-06-18T00:00:00Z
tag:
- ram-fisheries
title: Further exploration of RAM Legacy Stock Assessment data
url: /2015/06/18/RAM-explore/
---



<pre class="r"><code>suppressPackageStartupMessages({
library(&quot;dplyr&quot;)
library(&quot;RPostgreSQL&quot;)
library(&quot;devtools&quot;)
library(&quot;ggplot2&quot;)
})

## Perform this in data_raw to keep package dependencies minimal
mydb &lt;- src_postgres(dbname = &quot;srdb&quot;, 
                     host=&quot;nautilus-vm.mathstat.dal.ca&quot;, 
                     user = &quot;srdbuser&quot;, 
                     password =  &quot;srd6us3r!&quot;, 
                     port = 5432)

timeseries &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.timeseries&quot;)))
values &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.timeseries_values_view&quot;)))
units &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.timeseries_units_view&quot;)))
assessment &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.assessment&quot;)))
area &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.area&quot;)))
stock &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.stock&quot;)))
method &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.assessmethod&quot;)))
assessor &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.assessor&quot;)))
management  &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.management&quot;)))
taxonomy &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.taxonomy&quot;)))
lmerefs &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.lmerefs&quot;)))
lmestock &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.lmetostocks&quot;)))
biometrics  &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.biometrics&quot;)))
bioparams &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.bioparams&quot;)))
tsmetrics &lt;- collect(tbl(mydb, sql(&quot;SELECT * FROM srdb.tsmetrics&quot;)))</code></pre>
<div id="north-atlantic-cod-data" class="section level2">
<h2>North Atlantic Cod data</h2>
<p>Select North Atlantic Cod, <em>Gadus morhua</em>:</p>
<pre class="r"><code>cod_ids &lt;-
  assessment %&gt;% 
  left_join(stock) %&gt;% 
  filter(scientificname==&quot;Gadus morhua&quot;) %&gt;% 
  select(assessid) %&gt;%
  unlist() %&gt;% unname() # we need a char string, not a data.frame</code></pre>
<pre><code>## Joining, by = &quot;stockid&quot;</code></pre>
<p>(Note we could have selected on the <code>tsn==164712</code> to be less ambiguous but also less semantic, or on <code>commonname==&quot;Atlantic cod&quot;</code> to be more reader friendly but even more ambiguous. Fortunately the common and scientific names are well aligned with the <code>tsn</code> ids in this case and we get the same set of 22 stock assessments.)</p>
<p>Before we can combine across these, we must verify that each assessment measures the quantities of interest using the same units, or otherwise correct those that do not:</p>
<pre class="r"><code>units %&gt;% filter(assessid %in% cod_ids) %&gt;% select(assessid, catch_landings_unit) %&gt;% group_by(catch_landings_unit) %&gt;% summarise(length(catch_landings_unit))</code></pre>
<pre><code>## # A tibble: 1 × 2
##   catch_landings_unit `length(catch_landings_unit)`
##                 &lt;chr&gt;                         &lt;int&gt;
## 1                  MT                            21</code></pre>
<pre class="r"><code>units %&gt;% filter(assessid %in% cod_ids) %&gt;% select(assessid, total_unit) %&gt;% group_by(total_unit) %&gt;% summarise(length(total_unit))</code></pre>
<pre><code>## # A tibble: 3 × 2
##   total_unit `length(total_unit)`
##        &lt;chr&gt;                &lt;int&gt;
## 1        E03                    1
## 2         MT                   18
## 3       &lt;NA&gt;                    2</code></pre>
<p>All catches are in metric tons, so no concern there.</p>
<p>Landing data we can plot immediately:</p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% cod_ids) %&gt;% 
  group_by(tsyear) %&gt;% 
  summarise(catch = sum(catch_landings, na.rm=TRUE)) %&gt;% ## all units are metric tons
  ggplot(aes(tsyear, catch)) + geom_line() + 
    ylab(&quot;Catch/Landings (MT)&quot;) + xlab(&quot;Year&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Note that missing data is removed, such that any assessment without catch data is treated as zero catch. This could be the case (maybe not all assessments correspond to unique catch zones.) We also assume catch reported in one assessment is not also reported in a different assement (e.g. no double-counting). Lastly, we must bear in mind that this is catch/landings data, which may include bycatch, underreporting, etc.</p>
<hr />
</div>
<div id="handling-unit-conversions" class="section level2">
<h2>Handling unit conversions</h2>
<p>The units for <code>total</code> are more problematic. The <code>NA</code> simply indicates stocks that do not have the an estimate for <code>total</code>, but we also see one assessment has totals in <code>E03</code> (thousands) instead of metric tons.</p>
<hr />
<p><em>Sidebar</em> how do we know for sure that <code>E03</code> is abundance counts in thousands of fish?</p>
<p>The database does not provide metadata for these unit definitions directly. the <code>values</code> data and its associated <code>units</code> metadata are actually derived tables from the raw <code>timeseries</code> table and the associated <code>tsmetrics</code> unit metadata, so we would have to dive in there to confirm this interpretation of <code>E03</code> in this case.</p>
<pre class="r"><code># tidy up the tsmetrics table:
unit_defs &lt;- tsmetrics %&gt;% rename(tsid = tsunique) %&gt;% select(tsid, tslong, tsunitslong) 

# Find the assessid of the cod stock assessment that measures total in units of E03
who &lt;- units %&gt;% filter(assessid %in% cod_ids) %&gt;% select(assessid, total_unit) %&gt;% filter(total_unit==&quot;E03&quot;)

# Find that assessid in the timeseries table, where units are written in different notation
ts_who &lt;- timeseries %&gt;% filter(assessid %in% who$assessid) %&gt;% select(assessid, tsid) %&gt;%  distinct(tsid)

# Join the tables to see the definitions
left_join(ts_who, unit_defs)</code></pre>
<pre><code>## Joining, by = &quot;tsid&quot;</code></pre>
<pre><code>## # A tibble: 5 × 3
##     tsid
##    &lt;chr&gt;
## 1 SSB-MT
## 2 TN-E03
## 3  R-E03
## 4  F-1/T
## 5  TC-MT
## # ... with 2 more variables: tslong &lt;chr&gt;, tsunitslong &lt;chr&gt;</code></pre>
<p>and we can confirm <code>E03</code> is in this case <code>TN-E03</code> (total number, in thousands).</p>
<hr />
<p>Converting this to metric tons will require an average weight for cod. FishBase gives us a maximum weight (in grams):</p>
<pre class="r"><code>rfishbase::species(&quot;Gadus morhua&quot;, fields=&quot;Weight&quot;)</code></pre>
<pre><code>##        sciname Weight SpecCode
## 1 Gadus morhua  96000       69</code></pre>
<p>Wikipedia says the average is 5-12 kilograms, so let’s take 8.5 Kg for sake of argument. Clearly a more programmatic and more accurate solution is needed here.</p>
<p><em>Sidenote</em> the database has some very limited data on biometrics by assessment, including some assessments that record a maximum (but not an average) weight (sometimes pulled from FishBase anyway). Even pooling across all Atlantic Cod assessments we can’t find even a maximum weight.</p>
<pre class="r"><code># Find the unit code for max weight
biometrics %&gt;% filter(biolong == &quot;Maximum weight&quot;) %&gt;% select(biounique) %&gt;% unlist() %&gt;% unname() -&gt; max_weight
# show the unit code:
max_weight</code></pre>
<pre><code>## [1] &quot;MAX-WGT-g&quot;</code></pre>
<pre class="r"><code># Look up all max weight values for illustration: (not filtering on cod_ids since there are no hits)
bioparams %&gt;% filter(bioid %in% max_weight)</code></pre>
<pre><code>## # A tibble: 17 × 5
##                                   assessid     bioid  biovalue bioyear
##                                      &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;
## 1      INIDEP-ARGANCHOSARG-1992-2007-Parma MAX-WGT-g        51    2008
## 2      INIDEP-ARGANCHONARG-1989-2007-Parma MAX-WGT-g        48    2008
## 3       INIDEP-ARGHAKESARG-1985-2008-Parma MAX-WGT-g   5300.00    NULL
## 4       INIDEP-ARGHAKENARG-1985-2007-Parma MAX-WGT-g   5900.00    NULL
## 5  INIDEP-PATGRENADIERSARG-1983-2006-Parma MAX-WGT-g      2940        
## 6            ICCAT-ALBANATL-1929-2005-WORM MAX-WGT-g     60000    NULL
## 7         ICCAT-ATBTUNAEATL-1969-2007-WORM MAX-WGT-g    684000    NULL
## 8         ICCAT-ATBTUNAWATL-1969-2007-WORM MAX-WGT-g    684000    NULL
## 9   AFSC-SABLEFEBSAIGA-1956-2008-MELNYCHUK MAX-WGT-g      6200    NULL
## 10           IPHC-PHALNPAC-1988-2009-Parma MAX-WGT-g available    NULL
## 11     AFSC-REYEROCKBSAI-1974-2009-STANTON MAX-WGT-g      2047    NULL
## 12            NEFSC-ATHAL5YZ-1800-2007-COL MAX-WGT-g    337000    NULL
## 13     NEFSC-SCUPNWATLC-1960-2007-TERCEIRO MAX-WGT-g      3000    NULL
## 14     NEFSC-MONKGOMNGB-1964-2006-RICHARDS MAX-WGT-g    337000    2008
## 15      NEFSC-SURFMATLC-1965-2008-JACOBSON MAX-WGT-g      600+    NULL
## 16   CSERG-ANCHOVYKILKACS-1991-2007-JENSEN MAX-WGT-g      18.4    NULL
## 17        ASMFC-PANDALGOM-1960-2009-IDOINE MAX-WGT-g        23    2008
## # ... with 1 more variables: bionotes &lt;chr&gt;</code></pre>
<pre class="r"><code>e03_to_MT &lt;- 7.5 * 1e-3

tmpA &lt;- 
  values %&gt;% 
  filter(assessid %in% who$assessid) %&gt;% 
  mutate(total_mt = total * e03_to_MT)

everyone_else &lt;- cod_ids[!(cod_ids %in% who$assessid)]
tmpB &lt;-
  values %&gt;% 
  filter(assessid %in% everyone_else) %&gt;% 
  mutate(total_mt = total)

std_values &lt;- bind_rows(tmpA,tmpB)</code></pre>
<p>(Not sure if there is a more consise way to change the values in a given column for a subset of the rows). Well, perhaps it would be simpler to treat non-standard units as missing data, but at least this illustrates a mechanism for handling the conversion.</p>
<pre class="r"><code>biomass &lt;-
  std_values %&gt;% 
  filter(assessid %in% cod_ids) %&gt;% 
  group_by(tsyear) %&gt;% 
  summarise(biomass = sum(total_mt, na.rm=TRUE)) %&gt;% ## WARNING -- should check units!
  filter(biomass &gt; 0) 

biomass_dropped &lt;-
  values %&gt;% 
  filter(assessid %in% everyone_else) %&gt;% 
  group_by(tsyear) %&gt;% 
  summarise(biomass = sum(total, na.rm=TRUE)) %&gt;% ## WARNING -- should check units!
  filter(biomass &gt; 0) 

biomass_wrong &lt;-
  values %&gt;% 
  filter(assessid %in% cod_ids) %&gt;% 
  group_by(tsyear) %&gt;% 
  summarise(biomass = sum(total, na.rm=TRUE)) %&gt;% ## WARNING -- should check units!
  filter(biomass &gt; 0) 

ggplot(biomass, aes(tsyear, biomass)) + 
  geom_line() +
  geom_line(data=biomass_wrong, col=&quot;blue&quot;, lty=2) +
  geom_line(data=biomass_dropped, col=&quot;red&quot;, lty=2) +
  ylab(&quot;Biomass (MT)&quot;) + xlab(&quot;Year&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre class="r"><code># they may look identical but they aren&#39;t:
identical(biomass_dropped$biomass, biomass$biomass)</code></pre>
<pre><code>## [1] FALSE</code></pre>
<p>In this case, the contribution is negligible (red vs black). Even failing to convert units (blue) makes a hardly visible difference, though in general the difference could have been quite large.</p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% cod_ids, total &gt; 0) %&gt;%
ggplot(aes(tsyear, total, color=assessid)) + 
  geom_line() +
  ylab(&quot;Biomass (MT)&quot;) + xlab(&quot;Year&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<hr />
</div>
<div id="stock-recruitment-time-series" class="section level2">
<h2>Stock-recruitment &amp; time-series</h2>
<pre class="r"><code>values %&gt;% filter(assessid %in% cod_ids[[1]]) %&gt;% ggplot(aes(ssb, r)) + geom_point()</code></pre>
<pre><code>## Warning: Removed 2 rows containing missing values (geom_point).</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<pre class="r"><code>values %&gt;% filter(assessid==&quot;AFWG-CODNEAR-1943-2006-MINTO&quot;) %&gt;% ggplot(aes(ssb, r)) + geom_point()</code></pre>
<pre><code>## Warning: Removed 6 rows containing missing values (geom_point).</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-11-2.png" width="672" /></p>
<pre class="r"><code>values %&gt;%
  filter(assessid %in% cod_ids) %&gt;%
  filter(!is.na(r), !is.na(ssb)) %&gt;%
  ggplot(aes(ssb, r)) +
    geom_point() +
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-11-3.png" width="672" /></p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% cod_ids) %&gt;%
  filter(!is.na(total)) %&gt;% 
  ggplot(aes(tsyear, total)) + 
  geom_line(aes(tsyear, ssb), col=&quot;red&quot;) +
    geom_line() + 
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-11-4.png" width="672" /></p>
<p>Note that the spawning stock biomass, red, can often be significantly less than the total stock (black).</p>
<pre class="r"><code>herring &lt;-
  assessment %&gt;% 
  left_join(stock) %&gt;% 
  filter(commonname==&quot;Herring&quot;) %&gt;% 
  select(assessid) %&gt;%
  unlist() %&gt;% unname() # we need a char string, not a data.frame</code></pre>
<pre><code>## Joining, by = &quot;stockid&quot;</code></pre>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% herring) %&gt;%
  filter(!is.na(r), !is.na(ssb)) %&gt;% 
  ggplot(aes(ssb, r)) + 
    geom_point() + 
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% herring) %&gt;%
  filter(!is.na(total)) %&gt;% 
  ggplot(aes(tsyear, total)) + 
    geom_line() + 
    geom_line(aes(tsyear, ssb), col=&quot;red&quot;) +
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-12-2.png" width="672" /></p>
<pre class="r"><code>anchovy &lt;-
  assessment %&gt;% 
  left_join(stock) %&gt;% 
  filter(commonname==&quot;Anchovy&quot;) %&gt;% 
  select(assessid) %&gt;%
  unlist() %&gt;% unname() # we need a char string, not a data.frame</code></pre>
<pre><code>## Joining, by = &quot;stockid&quot;</code></pre>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% anchovy) %&gt;%
  filter(!is.na(r), !is.na(ssb)) %&gt;% 
  ggplot(aes(ssb, r)) + 
    geom_point() + 
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% anchovy) %&gt;%
  filter(!is.na(total)) %&gt;% 
  ggplot(aes(tsyear, total)) + 
    geom_line() + 
    geom_line(aes(tsyear, ssb), col=&quot;red&quot;) +
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-13-2.png" width="672" /></p>
<pre class="r"><code>bluefin &lt;-
  assessment %&gt;% 
  left_join(stock) %&gt;% 
  filter(commonname==&quot;Atlantic bluefin tuna&quot;) %&gt;% 
  select(assessid) %&gt;%
  unlist() %&gt;% unname() # we need a char string, not a data.frame</code></pre>
<pre><code>## Joining, by = &quot;stockid&quot;</code></pre>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% bluefin) %&gt;%
  filter(!is.na(r), !is.na(ssb)) %&gt;% 
  ggplot(aes(ssb, r)) + 
    geom_point() + 
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<pre class="r"><code>values %&gt;% 
  filter(assessid %in% bluefin) %&gt;%
  filter(!is.na(total)) %&gt;% 
  ggplot(aes(tsyear, total)) + 
    geom_line() + 
    geom_line(aes(tsyear, ssb), col=&quot;red&quot;) +
    facet_wrap(~assessid, scales=&quot;free&quot;)</code></pre>
<p><img src="/lab-notebook/2015-06-18-RAM-explore_files/figure-html/unnamed-chunk-14-2.png" width="672" /></p>
</div>
