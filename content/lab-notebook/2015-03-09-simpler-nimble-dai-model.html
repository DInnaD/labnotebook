---
categories:
- ecology
date: 2015-03-09T00:00:00Z
tags:
- early-warning
- regime-shifts
- nimble
url: /2015/03/09/simpler-nimble-dai-model/
---



<div id="a-simpler-nimble-model" class="section level2">
<h2>A simpler Nimble model</h2>
<pre class="r"><code>library(&quot;nimble&quot;)</code></pre>
<pre><code>## 
## Attaching package: &#39;nimble&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     simulate</code></pre>
<pre class="r"><code>library(&quot;methods&quot;)

library(&quot;regimeshifts&quot;)
library(&quot;tidyr&quot;)
library(&quot;ggplot2&quot;)
library(&quot;dplyr&quot;)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
</div>
<div id="lsn-version" class="section level2">
<h2>LSN version</h2>
<p>A further simplified version:</p>
<ul>
<li>fix <code>sigma_x</code> to unity and <code>theta</code> to zero, reflecting the detrending and scaling.</li>
<li>constrain <code>sigma_y</code> with a tight prior</li>
</ul>
<pre class="r"><code>code &lt;- nimbleCode({
# sigma_x ~ dunif(1e-10, 1e2)
  
  ## highly constrained
  sigma_y ~ dgamma(10, 1000)

  ## Uninformative
       m ~ dunif(-1e2, 1e2)
    x[1] ~ dunif(-1e3, 1e3)
    y[1] ~ dunif(-1e3, 1e3) 

  for(i in 1:(N-1)){
    mu_x[i] &lt;- x[i] - y[i] * x[i]
    x[i+1] ~ dnorm(mu_x[i], sd = 1) 
    y[i+1] ~ dnorm(y[i] + m * t[i] / t[N], sd = sigma_y) 
    
  }
})</code></pre>
<p>Generate the test data:</p>
<pre class="r"><code>set.seed(1000)
N &lt;- 50
DF &lt;- seq(0, 2000, length=N) # schedule for env degredation (increased dilution)
x &lt;- numeric(N)   
x[1] &lt;- 1.76e5 # initial density
   
for(day in 1:(N-1)){
 x[day+1] &lt;- dai(x[day], DF = DF[day])
}

raw &lt;- data.frame(t = 1:N, x = x)</code></pre>
<p>Detrend:</p>
<pre class="r"><code>raw$t &lt;- 1:N
detrend &lt;- loess(x ~ t, raw)
sigma &lt;- sqrt(var(detrend$residuals))
data &lt;- data.frame(x = detrend$residuals/sigma)
qplot(raw$t, data$x, geom=&#39;line&#39;)</code></pre>
<p><img src="/lab-notebook/2015-03-09-simpler-nimble-dai-model_files/figure-html/detrend-1.png" width="672" /></p>
<pre class="r"><code>constants &lt;- list(N = N, t = raw$t)
inits &lt;- list(m = 0, sigma_y = .01, y = rep(1,N))
thin &lt;- 1e2
n_iter &lt;- 1e6

Rmodel &lt;- nimbleModel(code = code, constants = constants, data = data, inits = inits)</code></pre>
<pre><code>## defining model...</code></pre>
<pre><code>## building model...</code></pre>
<pre><code>## setting data and initial values...</code></pre>
<pre><code>## running calculate on model (any error reports that follow may simply
## reflect missing values in model variables) ...</code></pre>
<pre><code>## </code></pre>
<pre><code>## checking model sizes and dimensions...</code></pre>
<pre><code>## </code></pre>
<pre><code>## model building finished.</code></pre>
<pre class="r"><code>Cmodel &lt;- compileNimble(Rmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.</code></pre>
<pre><code>## compilation finished.</code></pre>
<pre class="r"><code>mcmcspec &lt;- configureMCMC(Rmodel, print=FALSE, thin=thin)
  
Rmcmc &lt;- buildMCMC(mcmcspec)
Cmcmc &lt;- compileNimble(Rmcmc, project = Cmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.
## compilation finished.</code></pre>
<pre class="r"><code>Cmcmc$run(n_iter)</code></pre>
<pre><code>## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|</code></pre>
<pre><code>## NULL</code></pre>
<pre class="r"><code>samples &lt;- as.data.frame(as.matrix(Cmcmc$mvSamples))
samples &lt;- samples[,1:(length(inits) - 1)]
df &lt;- gather(samples)</code></pre>
<div id="summary-statistics" class="section level4">
<h4>Summary statistics</h4>
<pre class="r"><code>summarise(group_by(df, key), mean=mean(value), std=sqrt(var(value)))</code></pre>
<pre><code>## # A tibble: 2 × 3
##       key        mean        std
##     &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
## 1       m -0.02118436 0.02327253
## 2 sigma_y  0.01001409 0.00316794</code></pre>
</div>
<div id="traces" class="section level4">
<h4>Traces</h4>
<pre class="r"><code>ggplot(sample_n(df, 2e2)) + 
  geom_line(aes(seq_along(value), value)) + 
  facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-03-09-simpler-nimble-dai-model_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="posteriors" class="section level4">
<h4>Posteriors</h4>
<pre class="r"><code>ggplot(df) + 
  geom_density(aes(value)) + 
  facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-03-09-simpler-nimble-dai-model_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="block-sampler" class="section level4">
<h4>Block sampler</h4>
<pre class="r"><code>constants &lt;- list(N = N, t = raw$t)
inits &lt;- list(m = 0, sigma_y = .01, y = rep(1,N))
Rmodel &lt;- nimbleModel(code = code, constants = constants, data = data, inits = inits)</code></pre>
<pre><code>## defining model...</code></pre>
<pre><code>## building model...</code></pre>
<pre><code>## setting data and initial values...</code></pre>
<pre><code>## running calculate on model (any error reports that follow may simply
## reflect missing values in model variables) ...</code></pre>
<pre><code>## </code></pre>
<pre><code>## checking model sizes and dimensions...</code></pre>
<pre><code>## </code></pre>
<pre><code>## model building finished.</code></pre>
<pre class="r"><code>Cmodel &lt;- compileNimble(Rmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.</code></pre>
<pre><code>## compilation finished.</code></pre>
<pre class="r"><code>mcmcspec &lt;- configureMCMC(Rmodel, print=FALSE,thin=thin)
mcmcspec$addSampler(type = &quot;RW_block&quot;, target=c(&#39;m&#39;,&#39;sigma_y&#39;), control = list(adaptInterval=100))
Rmcmc &lt;- buildMCMC(mcmcspec)
Cmcmc &lt;- compileNimble(Rmcmc, project = Cmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.
## compilation finished.</code></pre>
<pre class="r"><code>Cmcmc$run(n_iter)</code></pre>
<pre><code>## |-------------|-------------|-------------|-------------|
## |-------------------------------------------------------|</code></pre>
<pre><code>## NULL</code></pre>
<pre class="r"><code>samples &lt;- as.data.frame(as.matrix(Cmcmc$mvSamples))
samples &lt;- samples[,1:(length(inits)-1)]
df &lt;- gather(samples)

#df &lt;- my_mcmc(code=lsn, constants, data, inits)</code></pre>
</div>
<div id="summary-statistics-1" class="section level4">
<h4>Summary statistics</h4>
<pre class="r"><code>summarise(group_by(df, key), mean=mean(value), std=sqrt(var(value)))</code></pre>
<pre><code>## # A tibble: 2 × 3
##       key         mean         std
##     &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;
## 1       m -0.025367634 0.027055911
## 2 sigma_y  0.009965489 0.003102902</code></pre>
</div>
<div id="traces-1" class="section level4">
<h4>Traces</h4>
<pre class="r"><code>ggplot(sample_n(df, 1e3)) + 
  geom_line(aes(seq_along(value), value)) + 
  facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-03-09-simpler-nimble-dai-model_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
<div id="posteriors-1" class="section level4">
<h4>Posteriors</h4>
<pre class="r"><code>ggplot(df) + 
  geom_density(aes(value)) + 
    facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-03-09-simpler-nimble-dai-model_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<hr />
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.3.1 (2016-06-21)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Debian GNU/Linux 8 (jessie)
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] methods   stats     graphics  grDevices utils     datasets  base     
## 
## other attached packages:
## [1] dplyr_0.5.0             ggplot2_2.1.0           tidyr_0.6.0            
## [4] regimeshifts_0.0.0.9000 nimble_0.6-4           
## 
## loaded via a namespace (and not attached):
##  [1] igraph_1.0.1     Rcpp_0.12.7      knitr_1.15.20    magrittr_1.5    
##  [5] munsell_0.4.3    colorspace_1.2-7 lattice_0.20-34  R6_2.2.0        
##  [9] stringr_1.1.0    plyr_1.8.4       tools_3.3.1      grid_3.3.1      
## [13] gtable_0.2.0     DBI_0.5-1        coda_0.19-1      htmltools_0.3.5 
## [17] lazyeval_0.2.0   yaml_2.1.13      assertthat_0.1   digest_0.6.10   
## [21] tibble_1.2       bookdown_0.3.19  codetools_0.2-15 evaluate_0.10   
## [25] rmarkdown_1.1    blogdown_0.0.35  labeling_0.3     stringi_1.1.2   
## [29] scales_0.4.1</code></pre>
</div>
</div>
