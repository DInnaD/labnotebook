---
categories:
- ecology
code: true
date: 2015-01-04T00:00:00Z
tags:
- early-warning
- nimble
url: /2015/01/04/lsn-model-comparisons/
---



<pre class="r"><code>library(knitr)
library(nimble)</code></pre>
<pre><code>## 
## Attaching package: &#39;nimble&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     simulate</code></pre>
<pre class="r"><code>library(sde)</code></pre>
<pre><code>## Loading required package: MASS</code></pre>
<pre><code>## Loading required package: stats4</code></pre>
<pre><code>## Loading required package: fda</code></pre>
<pre><code>## Loading required package: splines</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;fda&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:nimble&#39;:
## 
##     inprod</code></pre>
<pre><code>## The following object is masked from &#39;package:graphics&#39;:
## 
##     matplot</code></pre>
<pre><code>## Loading required package: zoo</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre><code>## sde 2.0.15</code></pre>
<pre><code>## Companion package to the book</code></pre>
<pre><code>## &#39;Simulation and Inference for Stochastic Differential Equations With R Examples&#39;</code></pre>
<pre><code>## Iacus, Springer NY, (2008)</code></pre>
<pre><code>## To check the errata corrige of the book, type vignette(&quot;sde.errata&quot;)</code></pre>
<pre class="r"><code>library(ggplot2)
library(tidyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;tidyr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:Matrix&#39;:
## 
##     expand</code></pre>
<pre class="r"><code>library(&quot;methods&quot;)

opts_chunk$set(dev = &#39;png&#39;, 
               fig.width = 5, 
               fig.height = 5, 
               results = &#39;hide&#39;)</code></pre>
<p>Stick with SDE example as a reference point:</p>
<pre class="r"><code>set.seed(123)
d &lt;- expression(0.5 * (10-x))
s &lt;- expression(1) 
data &lt;- as.data.frame(sde.sim(X0=6,drift=d, sigma=s, T=20, N=100))</code></pre>
<pre><code>## sigma.x not provided, attempting symbolic derivation.</code></pre>
<pre class="r"><code>ggplot(data) + geom_line(aes(seq_along(x),x))</code></pre>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type ts. Defaulting to continuous.</code></pre>
<p><img src="/lab-notebook/2015-01-04-lsn-model-comparisons_files/figure-html/data-1.png" width="480" /></p>
<pre class="r"><code>N &lt;- length(data$x)</code></pre>
<div id="lsn-version" class="section level2">
<h2>LSN version</h2>
<p>Modify the LSN model to explicitly model the changing parameter as a hidden, stochastic variable</p>
<pre class="r"><code>lsn &lt;- nimbleCode({
        theta ~ dunif(1e-10, 100.0)
        sigma_x ~ dunif(1e-10, 100.0)
        sigma_y ~ dunif(1e-10, 100.0)
                    m ~ dunif(-1e2, 1e2)
             x[1] ~ dunif(0, 100)
             y[1] ~ dunif(0, 100) 

  for(i in 1:(N-1)){
    mu_x[i] &lt;- x[i] + y[i] * (theta - x[i]) 
    x[i+1] ~ dnorm(mu_x[i], sd = sigma_x) 
    mu_y[i] &lt;- y[i] + m * t[i]
    y[i+1] ~ dnorm(mu_y[i], sd = sigma_y) 
  }
})</code></pre>
<p>Constants in the model definition are the length of the dataset, <span class="math inline">\(N\)</span> and the time points of the sample. Note we’ve made time explicit, we’ll assume uniform spacing here.</p>
<pre class="r"><code>constants &lt;- list(N = N, t = 1:N)</code></pre>
<p>Initial values for the parameters</p>
<pre class="r"><code>inits &lt;- list(theta = 6, m = 0, sigma_x = 1, sigma_y = 1, y = rep(1,N))</code></pre>
<p>and here we go:</p>
<pre class="r"><code>Rmodel &lt;- nimbleModel(code = lsn, 
                      constants = constants, 
                      data = data, 
                      inits = inits)</code></pre>
<pre><code>## defining model...</code></pre>
<pre><code>## building model...</code></pre>
<pre><code>## setting data and initial values...</code></pre>
<pre><code>## running calculate on model (any error reports that follow may simply
## reflect missing values in model variables) ...</code></pre>
<pre><code>## </code></pre>
<pre><code>## checking model sizes and dimensions...</code></pre>
<pre><code>## </code></pre>
<pre><code>## model building finished.</code></pre>
<pre class="r"><code>Cmodel &lt;- compileNimble(Rmodel)</code></pre>
<pre><code>## compiling... this may take a minute. Use &#39;showCompilerOutput = TRUE&#39; to see C++ compiler details.</code></pre>
<pre><code>## compilation finished.</code></pre>
<pre class="r"><code>mcmcspec &lt;- configureMCMC(Rmodel, print=TRUE,thin=2e2)
Rmcmc &lt;- buildMCMC(mcmcspec)
Cmcmc &lt;- compileNimble(Rmcmc, project = Cmodel)</code></pre>
<pre class="r"><code>Cmcmc$run(1e6)</code></pre>
<p>and examine results</p>
<pre class="r"><code>samples &lt;- as.data.frame(as.matrix(Cmcmc$mvSamples))
dim(samples)
samples &lt;- samples[,1:4]
long &lt;- gather(samples)</code></pre>
<pre class="r"><code>apply(samples, 2, mean)</code></pre>
<pre><code>##             m       sigma_x       sigma_y         theta 
## -1.675333e-05  3.875174e-01  4.066872e-02  1.022867e+01</code></pre>
<pre class="r"><code>ggplot(long) + 
    geom_line(aes(seq_along(value), value)) + 
    facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-01-04-lsn-model-comparisons_files/figure-html/trace-1.png" width="480" /></p>
<pre class="r"><code>ggplot(long) + 
    geom_density(aes(value)) + 
    facet_wrap(~key, scale=&#39;free&#39;)</code></pre>
<p><img src="/lab-notebook/2015-01-04-lsn-model-comparisons_files/figure-html/histogram-1.png" width="480" /></p>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.3.1 (2016-06-21)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Debian GNU/Linux 8 (jessie)
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=C             
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] methods   splines   stats4    stats     graphics  grDevices utils    
## [8] datasets  base     
## 
## other attached packages:
## [1] tidyr_0.6.0    ggplot2_2.1.0  sde_2.0.15     zoo_1.7-13    
## [5] fda_2.4.4      Matrix_1.2-7.1 MASS_7.3-45    nimble_0.6-4  
## [9] knitr_1.15.20 
## 
## loaded via a namespace (and not attached):
##  [1] igraph_1.0.1     Rcpp_0.12.7      magrittr_1.5     munsell_0.4.3   
##  [5] colorspace_1.2-7 lattice_0.20-34  plyr_1.8.4       stringr_1.1.0   
##  [9] tools_3.3.1      grid_3.3.1       gtable_0.2.0     coda_0.19-1     
## [13] htmltools_0.3.5  yaml_2.1.13      assertthat_0.1   digest_0.6.10   
## [17] tibble_1.2       bookdown_0.3.19  codetools_0.2-15 evaluate_0.10   
## [21] rmarkdown_1.1    blogdown_0.0.35  labeling_0.3     stringi_1.1.2   
## [25] scales_0.4.1</code></pre>
</div>
