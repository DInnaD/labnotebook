<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.20.2" />
  <meta name="author" content="Carl Boettiger">
  

  
  
  
    
    
    <link rel="stylesheet" href="../../../../css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="../../../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../css/font-awesome.min.css">
  <link rel="stylesheet" href="../../../../css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  
  
    <link rel="stylesheet" href="../../../../css/cboettig.css">
  
  
  <link rel="alternate" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">
  <link rel="feed" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">

  <link rel="icon" type="image/png" href="../../../../img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../../img/apple-touch-icon.png">
  <link rel="canonical" href="../../../../2013/09/08/some-rfishbase-updates/">


  <title> | Boettiger Group</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">


<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../">Boettiger Group</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="../../../../index.html">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../members/">
            
            <span>Members</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../vita/">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../teaching/">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../lab-notebook">
            
            <span>Lab Notebook</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    
      
    <p>Ever since writing the <code>rfishbase</code> package I&rsquo;ve been frustrated by the
lack of a proper API from Fishbase.org that would allow access to that
wealth of information that is not exposed in the &ldquo;Summary XML&rdquo; files
from which <code>rfishbase</code> extracts its content.  Since writing the paper
in Journal of Fish Biology, I continue to receive user requests asking
if or how such-and-such a data element might be extracted.  Usually this
involves a disappointing boiler-plate reply about how the package is
limited to the &ldquo;Summary XML&rdquo; data and that improved query potential must
wait for a proper API from Fishbase.org at some unspecified time.</p>

<p>I have been in touch with many of the folks at Fishbase.org at various
times looking for ways to address these issues.  They have been
in general keenly supportive of the idea, but I gather that they are
largely overworked and under-resourced and as such, implementation of
any of these steps has been very slow.  Last October another rfishbase
user contacted me, who works full time as a software developer.  I put
him in touch with the UBC team, and he is willing to volunteer the hours
and expertise the FishBase development team lacks to help transform the
database into a full API.  I think this is a very promising development
and a nice example of a community effort, but still faces the same
fundamental challenges in getting things rolling. So, so far, no
<code>rfishbase</code> version 2.  (Actually in our semantic versioning it would
be the less romantic version 0.3 or 0.4 or so, depending on how many CRAN
submits we do before then and provided we don&rsquo;t break any backwards compatibility)&hellip;</p>

<p>One of the more frequent requests involves accessing quantitative trophic level
estimates provided for many species on the &ldquo;Ecology&rdquo; page, linked from the &ldquo;Summary page&rdquo;.
The only way to access this data is by scraping the HTML.</p>

<p>Previously I&rsquo;ve been reluctant to scrape the HTML directly for several reasons:</p>

<ul>
<li><p>It is generally unrealiable/unverifiable.  Without any metadata (rdfa or
microdata/microformats could have helped&hellip;) in the HTML to signpost that we
have the correct value, we are generally counting arbitrary header, div and span
elements, followed by some Regular Expression matching, to find the element we want.<br />
This is error-prone and easily broken by any changes in the html pages either over time
or between pages for different species.</p></li>

<li><p>Second, it puts a much greater load on the fishbase servers.  Often we cannot even start
by querying the page we want, (e.g. since URLs involve things like stock-ids that the end user will not
know and I haven&rsquo;t located a look-up table), so a single call may follow links through
several pages before parsing the data it needs.  Repeating such queries over many fish programmatically
can create a rather substantial burst of traffic that could slow or crash the servers.</p></li>

<li><p>It&rsquo;s slow.  Making all the queries takes time, even for a computer.  (Though caching, as we already do
in rfishbase, could take care of much this).</p></li>

<li><p>It is potentially time consuming and annoying to code the scaping.</p></li>
</ul>

<p>Okay, the last is just me being lazy.  Since this particular query about trophic level was a
common email request, and as the data was available from the &ldquo;Ecology&rdquo; page of a species
in the form of an HTML Table, (and hence somewhat less fragile to robustly identify&hellip;),
I thought I&rsquo;d give it a try.</p>

<p>Here&rsquo;s my approach (or see [source code]()). We would follow the same query structure as <code>getSize</code> did <sup class="footnote-ref" id="fnref:1"><a rel="footnote" href="#fn:1">1</a></sup>,
and execute several steps:</p>

<p>an argument &ndash; potentially a weird choice but oh well, that&rsquo;s what I did when I first wrote the rfishbase
API so may as well keep it. A more natural choice taking scientific names as arguments directly, instead
of needing to start with a which_fish query, should be added one day to the entire package API.</p>

<ol>
<li>Visit the Summary page of the requested fish</li>
<li>Find it&rsquo;s Ecology page</li>
<li>Find the Trophic level table</li>
<li>parse the table.<br /></li>
</ol>

<p>In code, that looks like this:</p>

<pre><code class="language-r">getTrophicLevel &lt;- function(fish.data = NULL,
                            path = NULL,
                            as_table=FALSE, 
                            from = c(&quot;diet composition&quot;, &quot;individual food items&quot;), 
                            unfished = FALSE,
                            justSE = FALSE,
                            justReference = FALSE){

  ids &lt;- getIds(fish.data = fish.data, path=path)
  out &lt;- sapply(ids, function(id){
    summaryPage &lt;- getSummary(id)
    ecologyPage &lt;- getEcology(summaryPage)
    tab &lt;- readTrophicLevel(ecologyPage)
    if(as_table)
      tab
    else
      parseTrophicLevel(tab, from=from, unfished=unfished,justSE=justSE, justReference=justReference)
    })
  out
}
</code></pre>

<p>Which has a whole bunch of options just to let the user control the format of the output / target value, since there are different numbers.</p>

<p>Each of the steps corresponds to it&rsquo;s own function:</p>

<pre><code class="language-r">getIds &lt;- function(fish.data=NULL, path=NULL){
  if(is.null(fish.data))
    fish.data &lt;- loadCache(path=path)
  ids &lt;- sapply(fish.data, `[[`, 'id')
  species.names &lt;- sapply(fish.data, `[[`, 'ScientificName')
  names(ids) &lt;- gsub(&quot; &quot;, &quot;_&quot;, species.names) # use underscores instead of spaces
  ids
}


getSummary &lt;- function(id){ 
  # Grab and parse page matching id
  url &lt;- paste0(&quot;http://www.fishbase.org/summary/speciessummary.php?id=&quot;, id)
  summaryPage &lt;- htmlParse(url) 
}

getEcology &lt;- function(summaryPage){
  link &lt;- xpathApply(summaryPage, &quot;//*[contains(@href, '/Ecology/FishEcologySummary.php')][1]&quot;, xmlAttrs)[[1]][[&quot;href&quot;]]
  ecologyPage &lt;- htmlParse(paste0(&quot;http://www.fishbase.org/&quot;, gsub(&quot;\\.\\./&quot;, &quot;&quot;, link)))
}


readTrophicLevel &lt;- function(ecologyPage){ 
  tab &lt;- readHTMLTable(ecologyPage)[[6]]
}
</code></pre>

<p>which are all nice and short and potentially self-explanatory.  Extracting values from the table we isolate
is done rather crudely at the moment and could no doubt be improved, but this is what I came up with:</p>

<pre><code class="language-r">parseTrophicLevel &lt;- function(tab, 
                              from = c(&quot;diet composition&quot;, &quot;individual food items&quot;), 
                              unfished = FALSE,
                              justSE = FALSE,
                              justReference = FALSE){
  from &lt;- match.arg(from)
  if(justReference)
    out &lt;- as.character(tab[3,2])
  else{
    col &lt;- 2
    adj &lt;- 0
    if(unfished)
      col &lt;- 4
    if(justSE)
      adj &lt;- 1
    if(from == &quot;diet composition&quot;)
      out &lt;- as.numeric(as.character(tab[2,col+adj]))
    else if(from == &quot;individual food items&quot;)
      out &lt;- as.numeric(as.character(tab[4,col+adj]))
  }
  out 
}

</code></pre>

<p>Most of these are internal functions of course, only the top <code>getTrophicLevel</code> is user-facing.<br />
The use is straight forward:</p>

<pre><code class="language-r">require(rfishbase)
data(fishbase)

getTrophicLevel(fish.data[1:10])
</code></pre>

<p>or any of the various optional configurations, e.g.</p>

<pre><code class="language-r">getTrophicLevel(fish.data[1:10], as_table=TRUE)
</code></pre>

<p>(which gives a list of tables matching these fish).</p>

<p>The astute reader might notice that with <code>EcologyPage</code> etc we have access to a lot more (tabular) data in this approach, which could be extended beyond that page as well, following the same template shown here.  Just a matter of time and the other limitations discussed above.</p>

<p>So anyway, if you need the getTrophicLevel, it&rsquo;s available now on the <a href="https://github.com/ropensci/rfishbase/issues/12">Github version</a> and should be on CRAN in the near future.  Meanwhile, I&rsquo;d certainly welcome other requests (or better yet, forks and pull requests implementing additional data fields along these same lines).</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">taking the <code>fish.data</code> list as
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
</ol>
</div>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:http://ogp.me/ns/article#">
  
  
  
<div class="article-metadata">

  <p>
  <span class="article-date">
    <i class="fa fa-calendar"></i>
    
    <time datetime="2013-09-08 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Sun, Sep 8, 2013
    </time>
    
  </span>
  </p>
    

  <p>
  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="../../../../categories/ecology">ecology</a
    >
    
  </span>
  
  
  </p>
  
  <p>
  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="../../../../tags/ropensci">ropensci</a
    >
    
  </span>
  
  
  </p>

</div>

 
  <br />
  
  <p><a class="btn btn-default" rel="prev" href='../../../../2013/09/09/lost-branches/'><i class="fa fa-chevron-left"></i> prev</a>
    <a class="btn btn-default" rel="next" href='../../../../2013/09/07/rnexml-milestone/'>next <i class="fa fa-chevron-right"></i></a></p>

  <br />

  <p> <a class="btn btn-default" 
         href="https://github.com/cboettig/cboettig.github.io/commits/master/content/lab-notebook/2013-09-08-some-rfishbase-updates.md"><i class="fa fa-clock-o"></i> history</a></p>

  <p> <i class="fa fa-barcode"></i> SHA: <a href="https://github.com/cboettig/cboettig.github.io/blob/9d9072923c46d635718a4624d6afff6b1ec2439f/content/lab-notebook/2013-09-08-some-rfishbase-updates.md">9d9072923</a></p> 


</aside>

    </div>
  </div>
</div>


<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'cboettig';
    var disqus_identifier = '\/2013\/09\/08\/some-rfishbase-updates\/';
    var disqus_title = '';
    var disqus_url = '\/2013\/09\/08\/some-rfishbase-updates\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>

<footer class="site-footer">
  <hr />
  <div class="container">

  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://carlboettiger.info/#me">
      <p>
      <script type="text/javascript" src="../../../../js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
           <a rel="foaf:weblog" type="application/atom+xml" href="../../../../index.xml"  
        class="showtooltip" title="RSS feeds for my blog-style entries." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    


    <div class="col-md-4 col-md-offset-1 col-xs-4">
	    <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="../../../../img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="../../../../img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="../../../../js/jquery-1.12.3.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="../../../../js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-18401403-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

 
