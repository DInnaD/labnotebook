<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.20.2" />
  <meta name="author" content="Carl Boettiger">
  

  
  
  
    
    
    <link rel="stylesheet" href="../../../../css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="../../../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../css/font-awesome.min.css">
  <link rel="stylesheet" href="../../../../css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  
  
    <link rel="stylesheet" href="../../../../css/cboettig.css">
  
  
  <link rel="alternate" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">
  <link rel="feed" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">

  <link rel="icon" type="image/png" href="../../../../img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../../img/apple-touch-icon.png">
  <link rel="canonical" href="../../../../2013/06/03/admb-basic-example/">


  <title> | Boettiger Group</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">


<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../">Boettiger Group</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="../../../../index.html">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../members/">
            
            <span>Members</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../vita/">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../teaching/">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../lab-notebook">
            
            <span>Lab Notebook</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    
      
    

<p>After a few <a href="https://github.com/cboettig/nonparametric-bayes/commits/b4576cfc0b5a0c87701348976875c8657f0fd048/inst/examples/admb-example.md">iterations</a> I have a working minimal example (below).  Hoping that ADMB is a bit more robust than vanilla <code>optim</code> out of R as I loop over data sets for the sensitivity analysis (<a href="https://github.com/cboettig/nonparametric-bayes/issues/32">#32</a>). Does not seem to hold in simple example here, not sure why.</p>

<ul>
<li>These notes correspond to script <a href="https://github.com/cboettig/nonparametric-bayes/blob/84a1025854987ef659b4ef17e172933d72547f6d/inst/examples/admb-example.md">84a102/admb-example.md</a></li>
</ul>

<h1 id="learning-admb">Learning ADMB</h1>

<p>Plotting and knitr options, (can generally be ignored)</p>

<h3 id="model-and-parameters">Model and parameters</h3>

<pre><code class="language-r">f &lt;- function(x,h,p)  x * exp(p[1] * (1 - x / p[2]) * (x - p[3]) / p[2] ) 
p &lt;- c(1, 10, 5)
K &lt;- 10  # approx, a li'l' less
Xo &lt;- 6 # approx, a li'l' less
</code></pre>

<p>Various parameters defining noise dynamics, grid, and policy costs.</p>

<pre><code class="language-r">sigma_g &lt;- 0.1
z_g &lt;- function() rlnorm(1,0, sigma_g)
x_grid &lt;- seq(0, 1.5 * K, length=50)
Tobs &lt;- 40
set.seed(123)
</code></pre>

<h3 id="sample-data">Sample Data</h3>

<pre><code class="language-r">x &lt;- numeric(Tobs)
x[1] &lt;- Xo
for(t in 1:(Tobs-1))
  x[t+1] = z_g() * f(x[t], h=0, p=p)
qplot(1:Tobs, x)
</code></pre>

<p><img src="http://farm3.staticflickr.com/2807/8956942302_0d7d47ea49_o.png" alt="plot of chunk obs" /></p>

<h2 id="maximum-likelihood-by-hand">Maximum Likelihood &ldquo;by hand&rdquo;</h2>

<pre><code class="language-r">STABLIZE = 1e-10
n = length(x)
mloglik &lt;- function(pars){ 
  r = pars[1]; k = pars[2]; c = pars[3]; s = pars[4];
  mu = (x+STABLIZE) * exp( r * (1 - x / (k+STABLIZE)) * (x - c) / (k + STABLIZE));
  mu = pmin(1e100, mu) # avoid infinite values 
  f = 0.5 * n * log(2 * pi) + n * log(s + STABLIZE) + 0.5 * sum(x - mu + STABLIZE)^2/ (s + STABLIZE)^2;

  f
  }
</code></pre>

<p>Starting from the true values we mostly just shrink the noise parameter:</p>

<pre><code class="language-r">init &lt;- c(p, sigma_g)
mloglik(init) #true minus loglik
</code></pre>

<pre><code>[1] -35.72
</code></pre>

<pre><code class="language-r">o &lt;- optim(init, mloglik, method=&quot;L&quot;, lower=1e-5, upper=1e5)
o$value
</code></pre>

<pre><code>[1] -247.6
</code></pre>

<pre><code class="language-r">o$par
</code></pre>

<pre><code>[1] 0.9967297 9.9813554 5.1742699 0.0008183
</code></pre>

<p>While starting from arbitrary values we still find the optim.</p>

<pre><code class="language-r">init &lt;- c(1,1,1,1)  
init &lt;- c(p, sigma_g)
mloglik(init) #true minus loglik
</code></pre>

<pre><code>[1] -35.72
</code></pre>

<pre><code class="language-r">o &lt;- optim(init, mloglik, method=&quot;L&quot;, lower=1e-5, upper=1e5)
o$value
</code></pre>

<pre><code>[1] -247.6
</code></pre>

<pre><code class="language-r">o$par
</code></pre>

<pre><code>[1] 0.9967297 9.9813554 5.1742699 0.0008183
</code></pre>

<p>Okay, now lets try admb.  We use R2admb which is just a convenient way to write our data and parameters into an admb file.</p>

<pre><code class="language-r"># install_github(&quot;R2admb&quot;, &quot;bbolker&quot;, subdir=&quot;R2admb&quot;) # dev version
library(R2admb)
</code></pre>

<h2 id="admb-definition">ADMB definition</h2>

<p>We still need to define the model using ADMB notation in the procedure section.  This is mostly like R or C++, with the exception of special functions like <code>square</code> in place of <code>^2</code>, <code>norm2</code> for the sum of squares, and <code>elem_prod</code> istead of <code>*</code> for the element-wise product of two arrays. The constant <code>pi</code> is given as <code>M_PI</code>, as typical of C/C++ libraries.  Where these other functions are defined I&rsquo;m not sure, but some useful guides to <a href="http://fish.washington.edu/research/MPAM/resources/ADMB_Minte-Vera.pdf">ADMB vector/matrix operations</a> or an (undefined) list of <a href="http://www.admb-project.org/developers/contribute-documentation/functions/keywords.txt/view">keywords</a>&hellip;</p>

<p>The equivalent model</p>

<pre><code class="language-r">model &lt;- 
paste(&quot;
PARAMETER_SECTION
  vector mu(1,n) // per capita mort prob
      
PROCEDURE_SECTION
  mu = log(x) + r * elem_prod((1 - x / k), (x - c) / k);
  f = 0.5 * n * log(2 * M_PI) + n * log(s) + 0.5 * norm2(x - exp(mu)) / square(s);
&quot;)
writeLines(model, &quot;model.tpl&quot;)
</code></pre>

<p>Without explicit handling of the overflow errors, ADMB does not give us reliable estimates with arbitrary starting conditions</p>

<pre><code class="language-r">setup_admb(&quot;/var/admb&quot;)
</code></pre>

<pre><code>[1] &quot;/var/admb&quot;
</code></pre>

<pre><code class="language-r">
df &lt;- data.frame(x=x)
params &lt;- list(r = 1, k = 1, c = 1, s = 1) ## starting parameters
bounds &lt;- list(r = c(1e-10, 1e3), k=c(1e-10, 1e3), c=c(1e-10, 1e3), s = c(1e-5,1e3)) ## bounds
dat &lt;- c(list(n = nrow(df)), df)
m1 &lt;- do_admb(&quot;model&quot;,
              data = dat,
              params = params,
              bounds = bounds,
              run.opts = run.control(checkparam=&quot;write&quot;,
                                     checkdata=&quot;write&quot;, clean=FALSE))
m1
</code></pre>

<pre><code>Model file: model_gen 
Negative log-likelihood: 146.5 
Coefficients:
     r      k      c      s 
0.9992 1.0023 1.0004 9.4369 
</code></pre>

<p>But does fine with good starting values.  Hmm.. thought that was supposed to be the other way around&hellip;</p>

<pre><code class="language-r">params &lt;- list(r = 1, k = 10, c = 5, s = .1) ## starting parameters

m1 &lt;- do_admb(&quot;model&quot;,
              data = dat,
              params = params,
              bounds = bounds,
              run.opts = run.control(checkparam=&quot;write&quot;,
                                     checkdata=&quot;write&quot;))
</code></pre>

<pre><code>Warning: running command './model_gen &gt; model_gen.out' had status 1
</code></pre>

<pre><code class="language-r">m1
</code></pre>

<pre><code>Model file: model_gen 
Negative log-likelihood: -423.8 
Coefficients:
        r         k         c         s 
2.025e-10 9.498e+00 1.051e+01 1.000e-05 
</code></pre>

<p>Which finds a better optim (though substantailly overfit in reality)</p>

<p>Hans suggests adding an error term in the function definitions rather than in limiting the bounds or log transforming the variables:</p>

<blockquote>
<p>The most common plase where
 this goes wrong is <sup>1</sup>&frasl;<sub>0</sub>, log(0), sqrt(0), pow(0,1) etc.
Your suggestion is OK, but usually I prefer to put
 in log(1e-10+my_expression), sqrt(1e-10+my_expression), pow(1e-10+my_expression,1)</p>
</blockquote>

<h2 id="misc">Misc</h2>

<ul>
<li><p>Finished off posts regarding DOIs and digital archiving.  A shorter version appears in my answer to <a href="http://opendata.stackexchange.com/questions/694/preservation-of-blog-posts-articles-and-essays/719#719">opendata.stackexchange</a> on blog archiving.</p></li>

<li><p>Interesting discussion on using PURL redirects with SHA hash to link to repositories.  For instance, the commit matching our arXiv submission of the ews-review paper is found at <a href="http://purl.org/cboettig/ews-review/33dfb58e24ceb5861dad7cf756cffe2c5d66a655">cboettig/ews-review/33dfb58e24ceb5861dad7cf756cffe2c5d66a655</a>.  If the hash shown in the PURL doesn&rsquo;t match the one at the repository then we know something has gone wrong, since it is impossible to change the contents without changing the hash.   This gives us a version-stable identifier that can always be remapped to this commit, even if Github should disappear.  Of course nothing guarentees that the PURL maintainer / package author does this updating, but in principle the system is more robust than simply linking to Github.</p></li>

<li><p>In other news, I should add some <a href="https://github.com/cboettig/labnotebook/issues/94">automatic link checking, #94</a> to the notebook.</p></li>
</ul>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:http://ogp.me/ns/article#">
  
  
  
<div class="article-metadata">

  <p>
  <span class="article-date">
    <i class="fa fa-calendar"></i>
    
    <time datetime="2013-06-03 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Mon, Jun 3, 2013
    </time>
    
  </span>
  </p>
    

  <p>
  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="../../../../categories/ecology">ecology</a
    >
    
  </span>
  
  
  </p>
  
  <p>
  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="../../../../tags/nonparametric-bayes">nonparametric-bayes</a
    >
    
  </span>
  
  
  </p>

</div>

 
  <br />
  
  <p><a class="btn btn-default" rel="prev" href='../../../../2013/06/04/sensitivity-of-gp-comparisons-in-further-examples/'><i class="fa fa-chevron-left"></i> prev</a>
    <a class="btn btn-default" rel="next" href='../../../../2013/06/03/doi-citable/'>next <i class="fa fa-chevron-right"></i></a></p>

  <br />

  <p> <a class="btn btn-default" 
         href="https://github.com/cboettig/cboettig.github.io/commits/master/content/lab-notebook/2013-06-03-ADMB-basic-example.md"><i class="fa fa-clock-o"></i> history</a></p>

  <p> <i class="fa fa-barcode"></i> SHA: <a href="https://github.com/cboettig/cboettig.github.io/blob/cd98680d81d38b2d90af25cb09955cd205505b2c/content/lab-notebook/2013-06-03-ADMB-basic-example.md">cd98680d8</a></p> 


</aside>

    </div>
  </div>
</div>


<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'cboettig';
    var disqus_identifier = '\/2013\/06\/03\/admb-basic-example\/';
    var disqus_title = '';
    var disqus_url = '\/2013\/06\/03\/admb-basic-example\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>

<footer class="site-footer">
  <hr />
  <div class="container">

  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://carlboettiger.info/#me">
      <p>
      <script type="text/javascript" src="../../../../js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
           <a rel="foaf:weblog" type="application/atom+xml" href="../../../../index.xml"  
        class="showtooltip" title="RSS feeds for my blog-style entries." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    


    <div class="col-md-4 col-md-offset-1 col-xs-4">
	    <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="../../../../img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="../../../../img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="../../../../js/jquery-1.12.3.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="../../../../js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-18401403-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

 
