<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.21" />
  <meta name="author" content="Carl Boettiger">
  

  
  
  
    
    
    <link rel="stylesheet" href="../../../../css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="../../../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../css/font-awesome.min.css">
  <link rel="stylesheet" href="../../../../css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  
  
    <link rel="stylesheet" href="../../../../css/cboettig.css">
  
  
  <link rel="alternate" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">
  <link rel="feed" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">

  <link rel="icon" type="image/png" href="../../../../img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../../img/apple-touch-icon.png">
  <link rel="canonical" href="../../../../2011/05/16/treebase-in-r-a-first-tutorial/">


  <title>TreeBASE in R: a first tutorial | Boettiger Group</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">


<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../">Boettiger Group</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="../../../../index.html">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../members/">
            
            <span>Members</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../vita/">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../teaching/">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../lab-notebook">
            
            <span>Lab Notebook</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<div class = "container">


<div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    <h1>TreeBASE in R: a first tutorial</h1> 
      
    

<p>My TreeBASE R package is essentially functional now.  Here&rsquo;s a quick tutorial on the kinds of things it can do.  Grab the <a href="https://github.com/cboettig/treeBASE/archives/master">treebase package here</a>, install and load the library into R.</p>

<p>TreeBASE provides two APIs to query the database, one which searches by the metadata associated with different publications (called <a href="http://sourceforge.net/apps/mediawiki/treebase/index.php?title=OAI-PMH">OAI-PMH</a>), and another which queries the phylogenies directly (called <a href="http://sourceforge.net/apps/mediawiki/treebase/index.php?title=API">Phylo-ws</a>).  They have somewhat redundant functions, but for our purposes the second one returns the actual data, while the first returns metadata.  A few examples will best illustrate how this all works.  We start with some queries of the metadata directly without downloading any trees.</p>

<ol>
<li><p>Trees can be downloaded with search_treebase(), using a variety of search conditions provided by Phylo-ws API.</p></li>

<li><p>Metadata can be searched by date using search_metadata.  Just Download all metadata for finer queries.</p></li>

<li><p>Metadata for a study can be grabbed using the study id.</p></li>
</ol>

<p>A few examples will better illustrate how this all works.</p>

<h2 id="metadata-queries">Metadata queries</h2>

<p>How has TreeBASE grown since it&rsquo;s inception?  Let&rsquo;s grab the metadata for all entries and histogram by publication year:</p>

<pre><code class="language-r">

all &lt;- search_metadata(&quot;&quot;, by=&quot;all&quot;)
dates &lt;- sapply(all, function(x) as.numeric(x$date))
hist(dates, main=&quot;TreeBase growth&quot;, xlab=&quot;Year&quot;)


</code></pre>

<p><img src="http://farm3.staticflickr.com/2676/5711820192_95ab0fc731_o.png" alt="" /></p>

<p>What journals have submitted the most studies to treebase?</p>

<pre><code class="language-r">

journals &lt;- sapply(all, function(x) x$publisher)
J &lt;- tail(sort(table(as.factor(unlist(journals)))),5)
b &lt;- barplot(as.numeric(J))
text(b, names(J), srt=70, pos=4, xpd=T)


</code></pre>

<p><img src="http://farm6.staticflickr.com/5125/5728023288_1737290073_o.png" alt="" /></p>

<p>How many have been submitted from <em>Nature</em>? <em>Science</em>?</p>

<pre><code class="language-r">

nature &lt;- sapply(all, function(x) length(grep(&quot;Nature&quot;, x$publisher))&gt;0)
science &lt;- sapply(all, function(x) length(grep(&quot;^Science$&quot;, x$publisher))&gt;0)

sum(nature)

&gt; 11

sum(science)

&gt; 8


</code></pre>

<p>Which studies were those?  Can I have those trees please?</p>

<pre><code class="language-r">

s &lt;- get_study_id( all[nature] )

nature_trees &lt;- sapply(s, function(x) search_treebase(x, &quot;id.study&quot;))


</code></pre>

<p>Other details associated with the study are certainly also available.  Since we downloaded all metadata we have this stored already.  Any tree downloaded stores the TreeBASE study id in $S.id, ((and the unique tree id in $Tr.id)) which we can use to look up the metadata again.</p>

<pre><code class="language-r">

plot(nature_trees[[1]][[1]]) #plot first tree in the first study in the set

all[nature][1] # Pull metadata from complete list

# Or look up again using the study id:

metadata(nature_trees[[1]][[1]]$S.id)


</code></pre>

<h2 id="importing-phylogenies">Importing Phylogenies</h2>

<p>We can query for phylogenies directly on an array of search criteria, such as study authors, taxa included, number of taxa, number of characters in the trait matrix, etc, as illustrated by the following examples.  A few queries that aren&rsquo;t built into the API (i.e. does the tree have branch lengths) are accomplished by filtering after downloading the tree, which is slower.</p>

<pre><code class="language-r">

## We'll often use max_trees in the example so that they run quickly,
# notice the quotes for species.
dolphins &lt;- search_treebase('&quot;Delphinus&quot;', by=&quot;taxon&quot;, max_trees=5)
## can do exact matches
humans &lt;- search_treebase('&quot;Homo sapiens&quot;', by=&quot;taxon&quot;, exact_match=TRUE, max_trees=10)
# all trees with 5 taxa
five &lt;- search_treebase(5, by=&quot;ntax&quot;, max_trees = 10)
# These are different, a tree id isn't a Study id.  we report both
studies &lt;- search_treebase(&quot;2377&quot;, by=&quot;id.study&quot;)
tree &lt;- search_treebase(&quot;2377&quot;, by=&quot;id.tree&quot;)
c(&quot;TreeID&quot; = tree$Tr.id, &quot;StudyID&quot; = tree$S.id)
# Only results wiht branch lengths
# Has to grab all the trees first, then toss out ones without branch_lengths
Near &lt;- search_treebase(&quot;Near&quot;, &quot;author&quot;, branch_lengths=TRUE)
length(Near)


</code></pre>

<p>These queries can be combined with metadata searches</p>

<pre><code class="language-r">

#### Metadata examples ###
# Use the OAI-PMH api to check out the metadata from the study in which tree is published:
metadata(Near[[1]]$S.id)
# or manualy give a sudy id
metadata(&quot;2377&quot;)

</code></pre>

<h2 id="combining-metadata-and-phylogeny-queries">Combining metadata and phylogeny queries</h2>

<p>Metadata queries can optionally return only those studies added to TreeBASE before or after a given date:</p>

<pre><code class="language-r">

# Use that to get all trees &quot;published&quot; after 2010
# publication date is only a year
post2010 &lt;- sapply(dates, function(x) 2010 &lt; as.numeric(x))
s &lt;- get_study_id( all[post2010] )
out &lt;- lapply(s, function(x) search_treebase(x, &quot;id.study&quot;))
# Grab the trees entered since 2011: (some studies will have multiple trees)
#can compare dates with as.Date(&quot;2001-01-01&quot;, &quot;%y-%m-%d) &lt; as.Date ...
m &lt;- search_metadata(&quot;2011-05-05&quot;, by=&quot;from&quot;)
s &lt;- get_study_id(m)
out &lt;- lapply(s, function(x) search_treebase(x, &quot;id.study&quot;))

</code></pre>

<h2 id="a-simple-meta-analysis">A simple meta-analysis</h2>

<p>Of course, this capacity is most powerful not to merely get some summary statistics of the database, but repeat analyses of given studies or perform meta-analyses.  Most comparative phylogenetics methods require ultrametric trees.</p>

<p>We can assemble a simple pipeline to perform the meta-analysis across  all existing studies of whether phylogenies tend to fit a pure-birth or a  birth-death model more frequently:</p>

<p>As a proof-of-principle, we can create a pipeline that will estimate chronograms for all trees containing branchlengths in treebase.</p>

<pre><code class="language-r">

timetree &lt;- function(tree){
check.na &lt;- try(sum(is.na(tree$edge.length))&gt;0)
if(is(check.na, &quot;try-error&quot;) | check.na)
NULL
else
try( chronoMPL(multi2di(tree)) )
}
drop_errors &lt;- function(trees){
## apply to a list of trees created with timetree to drop errors
tt &lt;- tt[!sapply(trees, is.null)]
tt &lt;- tt[!sapply(tt, function(x) is(x, &quot;try-error&quot;))]
print(paste(&quot;dropped&quot;, length(trees)-length(tt), &quot;trees&quot;))
tt

}

require(laser)
pick_branching_model &lt;- function(tree){
 m1 &lt;- try(pureBirth(branching.times(tree)))
 m2 &lt;- try(bd(branching.times(tree)))
 as.logical(try(m2$aic &lt; m1$aic))
}

# Return all treebase trees that have branch lengths
# This has to download every tree in treebase, so not superfast...
all &lt;- search_treebase(&quot;Consensus&quot;, &quot;type.tree&quot;, branch_lengths=TRUE)
tt &lt;- drop_errors(sapply(all, timetree))
is_yule &lt;- sapply(tt, pick_branching_model)
table(is_yule)

</code></pre>

<h2 id="replicating-individual-studies">Replicating individual studies</h2>

<p>Replicating individual studies is a bit more challenging, mostly do to the quality of available data.  For instance, here is a nice recent study (Rowe <em>et. al.</em> 2011) that has nicely time calibrated chronograms (from BEAST, Figure 4) and species trees (using BEST, Figure 3), but it seems only the<a href="http://purl.org/phylo/treebase/dev/phylows/study/find?query=tb.identifier.study=10869&amp;format=rss1&amp;recordSchema=tree"> Mr. Bayes tree in Figure 2 is given in TreeBASE.</a></p>

<p>Further, replicating the study would require other data than the phylogenetic tree.  In the future we might hope that this data would appear on Dryad.  Dryad&rsquo;s web-based search frustratingly does not seem to allow a simple query by doi or treebase id, and a query by title returns a long list of <a href="http://datadryad.org/discover?&amp;query=Recent+and+Rapid+Speciation+with+Limited+Morphological+Disparity+in+the+Genus+Rattus.&amp;fq=dc.title%3ARecent+and+Rapid+Speciation+with+Limited+Morphological+Disparity+in+the+Genus+Rattus.&amp;filtertype=*&amp;filter=&amp;rpp=10&amp;sort_by=score&amp;order=DESC&amp;location=l2">things that aren&rsquo;t this paper</a>.</p>

<p>The Mendeley API (through my <a href="https://github.com/cboettig/RMendeley">RMendeley</a> package) does a bit better at pulling out some metadata, but not much.  Querying by the doi we can&rsquo;t find the paper, but the pmid works:</p>

<pre><code class="language-r">

require(RMendeley)

details(&quot;21239388&quot;, &quot;pmid&quot;)


</code></pre>

<p><a href="http://datadryad.org/handle/10255/dryad.1705">Some Dryad papers </a>have phylogenies, and the data deposition includes the BEAST xml files necessary to reproduce the phylogenies, but not, it seems, the phylogenies themselves.  It would be great to have some good examples of papers with data up on both TreeBASE and Dryad. Further, a pipeline that could regenerate the trees from the alignments might be interesting.</p>

<p>RaXML for inferring branch lengths: A quick solution for trees that have only topologies would be to infer branch lengths conditional on the topology from the character matrix.  TreeBASE does not include this with the nexus file containing the tree, and would require a separate query to pull the character matrix.  This is handled in the read.nexus.data command.</p>

<h2 id="references">References</h2>

<ul>
<li>Rowe K, Aplin K, Baverstock P and Moritz C (2011).
&ldquo;Recent And Rapid Speciation With Limited Morphological Disparity in The Genus Rattus.&rdquo;
<em>Systematic Biology</em>, <strong>60</strong>.
ISSN 1063-5157, <a href="http://dx.doi.org/10.1093/sysbio/syq092">http://dx.doi.org/10.1093/sysbio/syq092</a>.</li>
</ul>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:http://ogp.me/ns/article#">
  
  
  
<div class="article-metadata">

  <p>
  <span class="article-date">
    <i class="fa fa-calendar"></i>
    
    <time datetime="2011-05-16 19:46:54 &#43;0000 UTC" itemprop="datePublished">
      Mon, May 16, 2011
    </time>
    
  </span>
  </p>
    

  <p>
  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="../../../../categories/evolution">evolution</a
    >
    
  </span>
  
  
  </p>
  
  <p>
  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="../../../../tags/r">R</a
    >, 
    
    <a href="../../../../tags/ropensci">ropensci</a
    >
    
  </span>
  
  
  </p>

</div>

 
  <br />
  
  <p><a class="btn btn-default" rel="prev" href='../../../../2011/05/17/tuesday-3/'><i class="fa fa-chevron-left"></i> prev</a>
    <a class="btn btn-default" rel="next" href='../../../../2011/05/16/mathjax-the-smart-way-child-themes/'>next <i class="fa fa-chevron-right"></i></a></p>

  <br />

  <p> <a class="btn btn-default" 
         href="https://github.com/cboettig/cboettig.github.io/commits/master/content/lab-notebook/2011-05-16-treebase-in-r-a-first-tutorial.md"><i class="fa fa-clock-o"></i> history</a></p>

  <p> <i class="fa fa-barcode"></i> SHA: <a href="https://github.com/cboettig/cboettig.github.io/blob/9d9072923c46d635718a4624d6afff6b1ec2439f/content/lab-notebook/2011-05-16-treebase-in-r-a-first-tutorial.md">9d90729</a></p> 


</aside>

    </div>
  </div>
</div>


<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'cboettig';
    var disqus_identifier = '\/2011\/05\/16\/treebase-in-r-a-first-tutorial\/';
    var disqus_title = 'TreeBASE in R: a first tutorial';
    var disqus_url = '\/2011\/05\/16\/treebase-in-r-a-first-tutorial\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <hr />
  <div class="container">

  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://carlboettiger.info/#me">
      <p>
      <script type="text/javascript" src="../../../../js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
           <a rel="foaf:weblog" type="application/atom+xml" href="../../../../index.xml"  
        class="showtooltip" title="RSS feeds for my blog-style entries." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    


    <div class="col-md-4 col-md-offset-1 col-xs-4">
	    <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="../../../../img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="../../../../img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="../../../../js/jquery-1.12.3.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="../../../../js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-18401403-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    

  </body>
</html>

   