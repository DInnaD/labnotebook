<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.21" />
  <meta name="author" content="Carl Boettiger">
  

  
  
  
    
    
    <link rel="stylesheet" href="../../../../css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="../../../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../css/font-awesome.min.css">
  <link rel="stylesheet" href="../../../../css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  
  
    <link rel="stylesheet" href="../../../../css/cboettig.css">
  
  
  <link rel="alternate" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">
  <link rel="feed" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">

  <link rel="icon" type="image/png" href="../../../../img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../../img/apple-touch-icon.png">
  <link rel="canonical" href="../../../../2014/08/25/reproducible-research-environments-with-docker/">


  <title>Reproducible research environments with Docker | Boettiger Group</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">


<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../">Boettiger Group</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="../../../../index.html">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../members/">
            
            <span>Members</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../vita/">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../teaching/">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../lab-notebook">
            
            <span>Lab Notebook</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<div class = "container">


<div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    <h1>Reproducible research environments with Docker</h1> 
      
    

<p>Academic research takes place in computational environments of continually
increasing complexity.  This creates ever-higher barriers not only to
reproducing or extending the results of other researchers, but also
barriers to collaboration and training of new researchers.</p>

<p>Wouldn&rsquo;t it be nice if we could all work in equivalent computing
environments, such that whatever worked for me on my computer would work
for you on yours?  Wouldn&rsquo;t it be nice if we could just clone and copy
our entire software environment when we needed to move our computations
over to a more powerful cloud or cluster computer?  Or perhaps roll back
our environment to the state when everything was working yesterday?</p>

<h2 id="reproducibility-and-r">Reproducibility and R</h2>

<p>The situation for users for R is much better than most, since CRAN not
only handles most dependencies but provides binaries for most major
operating systems.  Though subsequent changes in packages can break this
chain and cause scripts that once worked to no longer due so, emerging
solutions like <a href="https://github.com/rstudio/packrat">packrat</a> try to tackle this problem.</p>

<p>Nevertheless, R is not immune from these issues.  Many packages make
use of code libraries from other languages, from <code>pandoc</code>&rsquo;s system for
rendering documents to interfaces with SQL databases, to manipulation of
other formats like XML, to highly optimized linear algebra libraries.
While an experienced user following careful documentation can usually
install the appropriate libraries to create a functionally equivalent
system, this raises substantial barriers for collaborators, students,
and others.  A <a href="https://storify.com/hlapp/reproducibility-repeatability-bigthink">reproducibility study at NESCENT</a> recently found
that even computationally savvy experts (though not necessarily specific to
the computer language or domain in question) working with code provided by
authors who were explicitly committed to reproducibility (including me),
could not even reconstruct the necessary computational environment. This
inability to install all the correct components for software to run in
the same way as it did for the original researchers is commonly known
as &lsquo;dependency hell&rsquo; and has often been shown as the primary cause
that computational components of research could not be replicated,
(not least because it is one of the very first steps required before
replication can be attempted).</p>

<p>Just about anyone who has taught a course involving running software in
class will be familiar with the challenges and lost instruction time
from installing such dependencies on student&rsquo;s machines.  Even when all
dependencies are installed successfully, there is a risk that these changes
will break some of the user&rsquo;s existing code by altering it&rsquo;s environment.</p>

<h2 id="jumping-in">Jumping in</h2>

<ul>
<li><a href="https://docs.docker.com/installation">Install Docker</a> for your
operating system using <code>boot2docker</code>. (Note the Linux instructions do not
require boot2docker. I recommend the 1-line curl-script install method
for Ubuntu).  Now you can launch <code>boot2docker</code> to open a terminal window
from where we will run Docker. NOTE: RStudio example requires Docker
version <code>&gt;= 1.2</code>.</li>
</ul>

<p>There&rsquo;s several different ways we can interact with the container.
The simplest approach is just run an R terminal on the container:</p>

<pre><code class="language-bash">sudo docker run --rm -it cboettig/rstudio /usr/bin/R
</code></pre>

<p>This should open up the R command line in the current window.</p>

<ul>
<li>Download and run an RStudio server instance:</li>
</ul>

<pre><code class="language-bash">sudo docker run -d -p 8787:8787 cboettig/rstudio
</code></pre>

<p>(These commands will be slow on the first run since the image must be
downloaded.  Afterwards they should be pretty quick.)</p>

<ul>
<li>You can now reach your RStudio server at
<code>http://&lt;system_ip_address&gt;:8787</code>.  For Windows/Mac users, run
<code>boot2docker ip</code> to get the value of <code>system_ip_address</code>. (This should be
<code>http://92.168.59.103:8787</code> but may vary as it is set dynamically).</li>
</ul>

<p>For Linux users, you can just use <code>http://localhost:8787</code>.  For cloud
instances, check your server&rsquo;s public IP address, and append the port
(<code>:8787</code>)..</p>

<ul>
<li>Login using the default rstudio:rstudio for user:pw, or configure
particular users (see below).</li>
</ul>

<h2 id="options">Options</h2>

<ul>
<li><p>Replace <code>cboettig/rstudio</code> with <code>cboettig/ropensci</code> to run a richer
(but larger) development environment.  See below for details.</p></li>

<li><p>Set user name and password using environmental variables, e.g.</p></li>
</ul>

<pre><code class="language-bash">docker run -d -p 8787:8787 -e USER=&lt;username&gt; -e PASSWORD=&lt;password&gt; -e EMAIL=you@somewhere.com cboettig/rstudio
</code></pre>

<ul>
<li>Link the container to a local folder (directory) using the <code>-v</code> option:</li>
</ul>

<pre><code class="language-bash">docker run --rm -it -v $(pwd):/home/rstudio/$(basename &quot;$PWD&quot;) cboettig/rstudio /usr/bin/R
</code></pre>

<p>Note that in this example we have launched an interactive R terminal,
rather than an RStudio server.  This linking would work just as well
with RStudio-server.  However, because we have linked the working
directory to the container, we are now free to use all our favorite
tools from our native operating system to edit and manage our files,
rather than being confined to RStudio.</p>

<p>Note that the volumes link (<code>-v</code>) is just taking the path to the
directory on the host followed by the path where it should appear inside
the container.  We could specify these manually, but <code>$(pwd)</code> is just
a convenient way to get the full path of the current working directory,
and <code>$basename &quot;$PWD&quot;</code> a way to get just the name of that directory. So
if working in <code>foo</code>, the directory <code>/path/to/foo</code> would be found at
<code>/home/rstudio/foo</code> on the container.  Here we&rsquo;re using the default user,
<code>rstudio</code>, but you would want to change that if specifying a different
user name as shown in the previous example.</p>

<p>Linking files on a Mac or PC requires an extra step.  This links us to
the <code>boot2docker</code> volume, but we still must link boot2docker virtual
machine to the host OS. It seems like <code>boot2docker</code> may still be working
on this issue.  Meanwhile, it is straight-forward to do this linking by
using <a href="http://vagrantup.com">vagrant</a> to launch boot2docker.  I discuss
this below.</p>

<ul>
<li><p>Download and run an RStudio server instance: <code>sudo docker run -d -p
8787:8787 cboettig/rstudio</code></p></li>

<li><p>You can now reach your RStudio server
at <code>http://&lt;system_ip_address&gt;:8787</code>.  For Windows/Mac users, run
<code>boot2docker ip</code> to get the value of <code>system_ip_address</code>. (This should
be <code>http://92.168.59.103:8787</code> but may vary as it is set dynamically).
For linux users, you can just use <code>localhost</code>.  For cloud instances,
check your server&rsquo;s public IP address.</p></li>

<li><p>login using the default <code>rstudio:rstudio</code> for <code>user:pw</code>, or configure particular users (see below).</p></li>
</ul>

<h2 id="rstudio-on-digital-ocean">RStudio on Digital Ocean</h2>

<p>Docker also makes it very fast and easy to deploy an RStudio instance in the
cloud.  More importantly, it lets you deploy an instance that already has your
preferred computational environment already completely installed and configured
through your docker container.  Running Docker on a cloud machine can be useful
for many purposes, such as:</p>

<ul>
<li>Giving your collaborator access to your computational environment</li>
<li>Scaling up a computation to a larger machine</li>
<li>running RStudio from your ipad</li>
</ul>

<p>Because we use RStudio for this, we have both a completely secured
connection and a familiar environment in which to interact with R.
RStudio in the browser looks and feels identical to the desktop edition.
Getting started with RStudio in the cloud is particularly easy using
Docker and the DigitalOcean cloud provider. We can run RStudio in the
<a href="https://www.digitalocean.com/pricing/">DigitalOcean cloud</a> for less
than 1 cent an hour ($5 / month if run continuously).  Creating an
account and launching your first DigitalOcean droplet is dead easy.
Head over to <a href="http://digitalocean.com">DigitalOcean.com</a> because they
do a much better job of walking you through the few simple steps than
I would. Create the cheapest droplet type to get started and ssh into
your image once it is up and running, using the ip-address for your
droplet and the password sent to you by email or an <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys--2">ssh key</a>.</p>

<pre><code class="language-bash">ssh root@ip-address
</code></pre>

<h3 id="enable-swapping-if-testing-on-the-smallest-image">Enable swapping if testing on the smallest image</h3>

<p>The smallest Digital Ocean servers have only 512 MB of memory and no
swap enabled.  Adding swap lets the machine cache things it doesn&rsquo;t
need in active memory, which can be important for running things like
<code>install.packages</code>.  On larger droplets this probably is not so much of
an issue.  Here, we enable 1GB of swap.  SSH into your
cloud server (or use the shell DigitalOcean provides in the browser),
and run:</p>

<pre><code class="language-bash">sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
</code></pre>

<h3 id="launch-rstudio">Launch RStudio</h3>

<p>We&rsquo;re now ready to run RStudio.  If you didn&rsquo;t select the <code>docker</code> application
while creating your image, you can install it now:</p>

<pre><code class="language-bash">curl -sSL https://get.docker.io/ubuntu/ | sudo sh
</code></pre>

<p>We&rsquo;re now ready to launch RStudio using docker, just as we did locally above.</p>

<pre><code class="language-bash">docker run -e USER=your_username -e=PASSWORD a_secure_pw \
  -d -p 8787:8787 --name rstudio cboettig/rstudio
</code></pre>

<p>Note that we pass a custom username and secure password in using the <code>-e</code> arguments
since our RStudio instance will be publically reachable by it&rsquo;s ip.  We&rsquo;ve also given
the container a name <code>rstudio</code> so we can easily refer to it later.  We now go to
<code>http://&lt;your-droplet-ip-address&gt;:8787</code> and login with these custom credentials
and we&rsquo;re ready to compute.</p>

<h3 id="saving-your-work">Saving your work</h3>

<p>The best way to save your work is to commit your entire docker image.  This will
save all installed packages, active RStudio sessions, files, and everything else,
even if we destroy the droplet later.  This gives us the option of running our
environment on a larger DigitalOcean image when the need arises, or running it
locally using the <code>boot2docker</code> approach outlined above.</p>

<p>From an ssh terminal into your droplet where you first ran docker, this command
will save your container as an image called <code>user/rstudio</code> (use any name combination
you like).</p>

<pre><code class="language-bash">docker commit rstudio user/rstudio
</code></pre>

<p>If you create an account on <a href="https://hub.docker.com">hub.docker.com</a> we can upload this as a
public or private image that we can access from anywhere for later use:</p>

<pre><code class="language-bash">docker push user/rstudio
</code></pre>

<p>Be sure to use this name to run your container in the future to pick up where
you left off.  If you&rsquo;d rather not use the Docker Hub to host your image,
you can download the image file instead:</p>

<pre><code class="language-bash">docker save -o rstudio.tar rstudio
</code></pre>

<p>Then from your local machine, <code>scp</code> the tar file to download it:</p>

<pre><code class="language-bash">scp root@&lt;ip-address&gt;:~/rstudio.tar .
</code></pre>

<p>You can now destroy your droplet to avoid future charges when not in use.
To deploy this image later, copy it over to the new machine and load in docker:</p>

<pre><code class="language-bash">scp rstudio.tar root@&lt;new-ip-address&gt;:~
docker load rstudio.tar
</code></pre>

<p>and then call <code>docker run</code> as before to get up and running.</p>

<h3 id="misc-remote-linux-clusters-without-root">Misc: Remote Linux clusters without root</h3>

<p>You can run the docker images on a remote linux cluster where you don&rsquo;t
have root access, even if it doesn&rsquo;t have a web-accessible API (such as
a university server).  Ask your friendly system administrator to install
vagrant and virtualbox.  Then we can use a lightweight virtualbox in
which we can run Docker (this is just what boot2docker does in windows
and mac, in fact, we&rsquo;ll use an image based on boot2docker since it has
just what we need, and at just 24 MB is way smaller than a standard
ubuntu virtualbox image).</p>

<p>A Vagrantfile for getting up and running with this image is found in the
<code>vagrant</code> directory.  This handles exporting ports to the host machine,
and sharing files with the host machine (which can also be tricky
for boot2docker users on Mac/Windows, so this might be a work-around
for them).  Run this image with:</p>

<pre><code class="language-bash">vagrant up
</code></pre>

<p>You may want to first adjust the Vagrantfile to allocate more or less
memory and CPU nodes to the virtual machine.  Vagrant&rsquo;s default is 512 MB
and 1 CPU, though the file currently puts this at 2 CPUS and 1024 MB RAM.</p>

<p>You can now connect to the RStudio server using some ssh port forwarding:</p>

<pre><code class="language-bash">ssh -o &quot;ExitOnForwardFailure yes&quot; -f -N -L 8787:localhost:8888 &lt;your.server&gt;
</code></pre>

<p>The first number (8787) is the port we want things to appear on localhost,
e.g. we can now connect by visiting <a href="http://localhost:8787">http://localhost:8787</a>.  The second
(8888) is the port we configured for the host machine with Vagrant.</p>

<p>Note that sometimes you need to tunnel through a head node to the compute
node where you want R to be running, replacing <code>&lt;your.server&gt;</code> with:</p>

<pre><code class="language-bash">ssh &lt;head.node.name&gt; nc -q0 &lt;compute.node.name&gt; 22
</code></pre>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:http://ogp.me/ns/article#">
  
  
  
<div class="article-metadata">

  <p>
  <span class="article-date">
    <i class="fa fa-calendar"></i>
    
    <time datetime="2014-08-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Mon, Aug 25, 2014
    </time>
    
  </span>
  </p>
    

  <p>
  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="../../../../categories/open-science">open-science</a
    >
    
  </span>
  
  
  </p>
  
  <p>
  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="../../../../tags/docker">docker</a
    >, 
    
    <a href="../../../../tags/ropensci">ropensci</a
    >, 
    
    <a href="../../../../tags/r">r</a
    >
    
  </span>
  
  
  </p>

</div>

 
  <br />
  
  <p><a class="btn btn-default" rel="prev" href='../../../../2014/08/29/docker-notes/'><i class="fa fa-chevron-left"></i> prev</a>
    <a class="btn btn-default" rel="next" href='../../../../2014/08/14/docker-notes/'>next <i class="fa fa-chevron-right"></i></a></p>

  <br />

  <p> <a class="btn btn-default" 
         href="https://github.com/cboettig/cboettig.github.io/commits/master/content/lab-notebook/2014-08-25-reproducible-research-environments-with-Docker.md"><i class="fa fa-clock-o"></i> history</a></p>

  <p> <i class="fa fa-barcode"></i> SHA: <a href="https://github.com/cboettig/cboettig.github.io/blob/9d9072923c46d635718a4624d6afff6b1ec2439f/content/lab-notebook/2014-08-25-reproducible-research-environments-with-Docker.md">9d90729</a></p> 


</aside>

    </div>
  </div>
</div>


<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'cboettig';
    var disqus_identifier = '\/2014\/08\/25\/reproducible-research-environments-with-docker\/';
    var disqus_title = 'Reproducible research environments with Docker';
    var disqus_url = '\/2014\/08\/25\/reproducible-research-environments-with-docker\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <hr />
  <div class="container">

  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://carlboettiger.info/#me">
      <p>
      <script type="text/javascript" src="../../../../js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
           <a rel="foaf:weblog" type="application/atom+xml" href="../../../../index.xml"  
        class="showtooltip" title="RSS feeds for my blog-style entries." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    


    <div class="col-md-4 col-md-offset-1 col-xs-4">
	    <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="../../../../img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="../../../../img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="../../../../js/jquery-1.12.3.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="../../../../js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-18401403-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    

  </body>
</html>

   