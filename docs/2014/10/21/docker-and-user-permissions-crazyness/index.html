<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Hugo 0.21" />
  <meta name="author" content="Carl Boettiger">
  

  
  
  
    
    
    <link rel="stylesheet" href="../../../../css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="../../../../css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../css/font-awesome.min.css">
  <link rel="stylesheet" href="../../../../css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700|Merriweather|Roboto+Mono">
  
  
    <link rel="stylesheet" href="../../../../css/cboettig.css">
  
  
  <link rel="alternate" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">
  <link rel="feed" href="../../../../index.xml" type="application/rss+xml" title="Boettiger Group">

  <link rel="icon" type="image/png" href="../../../../img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../../img/apple-touch-icon.png">
  <link rel="canonical" href="../../../../2014/10/21/docker-and-user-permissions-crazyness/">


  <title> | Boettiger Group</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">


<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../../">Boettiger Group</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="../../../../index.html">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../members/">
            
            <span>Members</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../vita/">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../teaching/">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="../../../../lab-notebook">
            
            <span>Lab Notebook</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>


<div class = "container">


<div class="row">
  <div class="col-md-7 col-md-offset-1">
    <article>
    
      
    <p>Lots of crazyness getting to the bottom of permissions changes, as discussed in:</p>

<ul>
<li><a href="https://github.com/rocker-org/rocker/issues/50">rocker issues tracker</a></li>
<li><a href="http://stackoverflow.com/questions/26500270">Stackoverflow question</a></li>
<li><a href="https://groups.google.com/forum/#!topic/docker-user/VFdFuZ4Ze_A">Docker mailing list</a></li>
</ul>

<p>Long story short: docker cares only about UIDs, so we have to explicitly make sure these match.  Some very good answers including from Docker core-team members on the discussion list.  Overall approach outlined at the end of the rocker issues tracker.</p>

<p>Here&rsquo;s the SO version of the question, for my reference:</p>

<hr />

<p>Consider the following trivial Dockerfile:</p>

<pre><code>FROM debian:testing
RUN  adduser --disabled-password --gecos '' docker
RUN  adduser --disabled-password --gecos '' bob 
</code></pre>

<p>in a working directory with nothing else. Build the docker image:</p>

<pre><code>docker build -t test .
</code></pre>

<p>and then run a bash script on the container, linking the working directory into a new subdir on bob&rsquo;s home directory:</p>

<pre><code>docker run --rm -it -v $(pwd):/home/bob/subdir test 
</code></pre>

<p>Who owns the contents of <code>subdir</code> on the container? On the container, run:</p>

<pre><code>cd /home/bob/subdir
ls -l
</code></pre>

<p>ad we see:</p>

<pre><code>-rw-rw-r-- 1 docker docker 120 Oct 22 03:47 Dockerfile
</code></pre>

<p>Holy smokes! <code>docker</code> owns the contents!  Back on the host machine outside the container, we see that our original user still owns the <code>Dockerfile</code>. Let&rsquo;s try and fix the ownership of <code>bob</code>&rsquo;s home directory. On the container, run:</p>

<pre><code>chown -R bob:bob /home/bob
ls -l 
</code></pre>

<p>and we see:</p>

<pre><code>-rw-rw-r-- 1 bob bob 120 Oct 22 03:47 Dockerfile
</code></pre>

<p>But wait! outside the container, we now run <code>ls -l</code></p>

<pre><code>-rw-rw-r-- 1 1001 1001 120 Oct 21 20:47 Dockerfile
</code></pre>

<p>we no longer own our own file.  Terrible news!</p>

<hr />

<p>If we had only added one user in the above example, everything would have gone more smoothly.  For some reason, Docker seems to be making any home directory owned by the <em>first</em> non-root user it encounters (even if that user is declared on an earlier image).  Likewise, this <em>first</em> user is the one that corresponds to the same ownership permissions as my home user.</p>

<p><strong>Question 1</strong> Is that correct?  Can someone point me to documentation of this, I&rsquo;m just conjecturing based on the above experiment.</p>

<p><strong>Question 2</strong>: Perhaps this is just because they both have the same numerical value on the kernel, and if I tested on a system where my home user was not id <code>1000</code> then permissions would get changed in every case?</p>

<p><strong>Question 3</strong>: The real question is, of course, &lsquo;what do I do about this?&rsquo; If <code>bob</code> is logged in as <code>bob</code> on the given host machine, he should be able to run the container as <code>bob</code> and not have file permissions altered under his host account.  As it stands, he actually needs to run the container as user <code>docker</code> to avoid having his account altered.</p>

<p>I hear you asking <em>Why do I have such a weird Dockerfile anyway?</em>. I wonder too sometimes. I am writing a container for a webapp (RStudio-server) that permits different users to log in, which simply uses the user names and credentials from the linux machine as the valid user names.  This brings me the perhaps unusual motivation of wanting to create multiple users.  I can get around this by creating the user only at runtime and everthing is fine.  However, I use a base image that has added a single <code>docker</code> user so that it can be used interactively without running as root (as per best practice).  This ruins everything since that user becomes the <em>first</em> user and ends up owning everything, so attempts to log on as other users fail (the app cannot start because it lacks write permissions).  Having the startup script run <code>chown</code> first solves this issue, but at the cost of linked volumes changing permissions (obviously only a problem if we are linking volumes).</p>

    </article>
  </div>
  <div class="col-md-4">
    <div class="sidebar">
      <aside prefix="og:http://ogp.me/ns/article#">
  
  
  
<div class="article-metadata">

  <p>
  <span class="article-date">
    <i class="fa fa-calendar"></i>
    
    <time datetime="2014-10-21 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      Tue, Oct 21, 2014
    </time>
    
  </span>
  </p>
    

  <p>
  
  
  
  <span class="article-categories">
    <i class="fa fa-folder"></i>
    
    <a href="../../../../categories/computation">computation</a
    >
    
  </span>
  
  
  </p>
  
  <p>
  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="../../../../tags/docker">docker</a
    >
    
  </span>
  
  
  </p>

</div>

 
  <br />
  
  <p><a class="btn btn-default" rel="prev" href='../../../../2014/10/28/jekyll-free/'><i class="fa fa-chevron-left"></i> prev</a>
    <a class="btn btn-default" rel="next" href='../../../../2014/10/20/notes/'>next <i class="fa fa-chevron-right"></i></a></p>

  <br />

  <p> <a class="btn btn-default" 
         href="https://github.com/cboettig/cboettig.github.io/commits/master/content/lab-notebook/2014-10-21-docker-and-user-permissions-crazyness.md"><i class="fa fa-clock-o"></i> history</a></p>

  <p> <i class="fa fa-barcode"></i> SHA: <a href="https://github.com/cboettig/cboettig.github.io/blob/9d9072923c46d635718a4624d6afff6b1ec2439f/content/lab-notebook/2014-10-21-docker-and-user-permissions-crazyness.md">9d90729</a></p> 


</aside>

    </div>
  </div>
</div>


<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'cboettig';
    var disqus_identifier = '\/2014\/10\/21\/docker-and-user-permissions-crazyness\/';
    var disqus_title = '';
    var disqus_url = '\/2014\/10\/21\/docker-and-user-permissions-crazyness\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>

<footer class="site-footer">
  <hr />
  <div class="container">

  <div class="row">
    <div class="col-md-3 col-xs-4 socialicons" style="font-size:20px" typeof="foaf:Person" about="https://carlboettiger.info/#me">
      <p>
      <script type="text/javascript" src="../../../../js/obfuscate-email-link.js"></script> 

          <a rel="foaf:account" href="https://twitter.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Twitter'); 
             return false;"><span class="showtooltip" title="follow me on twitter (reading, discussing)"><i class="fa fa-twitter"></i></span></a> 

          <a rel="foaf:account" href="https://github.com/cboettig" 
             onclick="recordOutboundLink(this, 'Outbound Links', 'Github'); 
             return false;"><span class="showtooltip" title="follow me on Github (code, research)"><i class="fa fa-github"></i></span></a>
           <a rel="foaf:weblog" type="application/atom+xml" href="../../../../index.xml"  
        class="showtooltip" title="RSS feeds for my blog-style entries." 
         onclick="recordOutboundLink(this, 'Outbound Links', 'RSS'); 
         return false;"><i class="fa fa-rss"></i></a>
       </p>
    </div>

    
    


    <div class="col-md-4 col-md-offset-1 col-xs-4">
	    <p><a onclick="recordOutboundLink(this, 'Outbound Links', 'ONS_claim'); return false;" href="http://onsclaims.wikispaces.com/"><img src="../../../../img/ons-aci2-icon.svg" alt="ONS" class="showtooltip" title="An Open Notebook Science (ONS) project claim: Entry provides all content (AC) immediately (I) or without significant delay.  See link for details"/></a></p>
    </div>


    <div class="col-md-3 col-md-offset-1 col-xs-4">
      <p>
      <a rel="license" property="http://creativecommons.org/ns#license" href="http://creativecommons.org/publicdomain/zero/1.0/" onclick="recordOutboundLink(this, 'Outbound Links', 'CC0'); return false;"><img src="../../../../img/cc-zero.svg" alt="CC0"/></a> 
      </p>
    </div>
  </div>
</footer>


    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script src="../../../../js/jquery-1.12.3.min.js"></script>
    <script src="../../../../js/bootstrap.min.js"></script>
    <script src="../../../../js/isotope.pkgd.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script src="../../../../js/hugo-academic.js"></script>
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-18401403-1', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    <script async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    

  </body>
</html>

   